# Work Package: M3 - 알림 시스템

**Milestone:** M3
**목표:** 사용자가 모임을 잊지 않게 자동 리마인드 알림을 받을 수 있다
**기간:** 1~2주
**선행 조건:** M2 완료

---

## 1. Work Package 개요

```
Phase 1: 알림 인프라 구축
    ↓
Phase 2: 모임 리마인드 알림
    ↓
Phase 3: 대기자 & 세그먼트 알림
    ↓
Phase 4: 운영자 알림 관리
```

**수직 분할 원칙:** 각 Phase 완료 시 특정 유형의 알림이 동작하는 상태

---

## 2. Phase 상세

### Phase 1: 알림 인프라 구축

**목표:** 알림 발송 시스템의 기반을 구축한다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 솔라피 API 연동 설정 | 환경 변수, API 키 | 연결 테스트 통과 |
| 1.2 | 알림 서비스 추상화 레이어 | `lib/notification/` | 인터페이스 정의 |
| 1.3 | 솔라피 알림톡 구현체 | `lib/notification/solapi.ts` | 발송 함수 구현 |
| 1.4 | notification_logs 테이블 생성 | DB 스키마 | 발송 기록 저장 |
| 1.5 | 알림 발송 기록 저장 로직 | API | 성공/실패 기록 |
| 1.6 | 알림톡 템플릿 등록 (카카오) | 카카오 비즈니스 | 템플릿 승인 |
| 1.7 | 테스트 알림 발송 기능 | 개발 도구 | 수동 테스트 |

#### Scenario (검증 기준)

**🔴 SC-M3-001: 알림톡 발송 성공**
- **Given:** 솔라피 API 키가 환경 변수에 설정되어 있고, 알림톡 템플릿이 승인된 상태
- **When:** 유효한 전화번호로 테스트 알림 발송 실행
- **Then:** 카카오톡 알림톡 수신 성공, 발송 상태 "success" 반환
- **선행:** 없음

**🟡 SC-M3-002: 알림톡 발송 실패 - 잘못된 API 키**
- **Given:** 솔라피 API 키가 잘못 설정된 상태
- **When:** 테스트 알림 발송 실행
- **Then:** 인증 오류 반환, 발송 상태 "failed" 기록
- **선행:** 없음

**🟡 SC-M3-003: 알림톡 발송 실패 - 잘못된 전화번호**
- **Given:** 솔라피 API 설정 완료
- **When:** 유효하지 않은 전화번호로 발송 시도
- **Then:** 전화번호 오류 반환, 발송 상태 "failed" 기록
- **선행:** SC-M3-001

**🔴 SC-M3-004: 발송 성공 기록 저장**
- **Given:** 알림 발송 성공
- **When:** 발송 완료 콜백 처리
- **Then:** notification_logs에 status="success", sent_at, recipient, message_type 저장
- **선행:** SC-M3-001

**🟡 SC-M3-005: 발송 실패 기록 저장**
- **Given:** 알림 발송 실패
- **When:** 발송 완료 콜백 처리
- **Then:** notification_logs에 status="failed", error_message 저장
- **선행:** SC-M3-002

**🟢 SC-M3-006: 알림 서비스 추상화 검증**
- **Given:** NotificationService 인터페이스와 SolapiNotificationService 구현체 존재
- **When:** 새로운 MockNotificationService 구현체 생성
- **Then:** 인터페이스만 구현하면 기존 코드 변경 없이 교체 가능
- **선행:** SC-M3-001

#### 사용자 가치
> "시스템이 알림을 발송할 수 있는 기반이 갖춰진다"

---

### Phase 2: 모임 리마인드 알림

**목표:** 모임 전 자동 리마인드 알림이 발송된다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | 리마인드 스케줄러 설정 | Vercel Cron / pg_cron | 정기 실행 |
| 2.2 | 모임 3일 전 리마인드 | 알림 함수 | D-3 알림 발송 |
| 2.3 | 모임 1일 전 리마인드 | 알림 함수 | D-1 알림 발송 |
| 2.4 | 모임 당일 리마인드 | 알림 함수 | D-Day 알림 발송 |
| 2.5 | 리마인드 대상 조회 쿼리 | DB 쿼리 | confirmed 상태만 |
| 2.6 | 중복 발송 방지 로직 | 체크 로직 | 동일 알림 재발송 방지 |
| 2.7 | 리마인드 알림 템플릿 | 메시지 내용 | 모임 정보 포함 |

#### Scenario (검증 기준)

**🔴 SC-M3-010: 3일 전 리마인드 발송**
- **Given:** 모임이 3일 후 예정, confirmed 상태 참가자 2명 존재
- **When:** 리마인드 Cron 실행 (오전 7시)
- **Then:** 2명 모두에게 "3일 후 [모임명] 모임이 있습니다" 알림 발송
- **선행:** SC-M3-001

**🔴 SC-M3-011: 1일 전 리마인드 발송**
- **Given:** 모임이 내일 예정, confirmed 상태 참가자 존재
- **When:** 리마인드 Cron 실행 (오전 7시)
- **Then:** "내일 [모임명] 모임이 있습니다" 알림 발송
- **선행:** SC-M3-001

**🔴 SC-M3-012: 당일 리마인드 발송**
- **Given:** 모임이 오늘 예정, confirmed 상태 참가자 존재
- **When:** 리마인드 Cron 실행 (오전 7시)
- **Then:** "오늘 [모임명] 모임입니다" 알림 발송
- **선행:** SC-M3-001

**🟡 SC-M3-013: 취소된 참가자 리마인드 제외**
- **Given:** 모임 3일 전, 참가자 A(confirmed), 참가자 B(cancelled)
- **When:** 리마인드 Cron 실행
- **Then:** 참가자 A에게만 알림 발송, B는 제외
- **선행:** SC-M3-010

**🟡 SC-M3-014: 중복 발송 방지**
- **Given:** 3일 전 리마인드가 이미 발송됨 (notification_logs에 기록 존재)
- **When:** Cron이 같은 날 다시 실행
- **Then:** 동일 (회원, 모임, 알림타입) 조합으로 재발송되지 않음
- **선행:** SC-M3-010

**🟢 SC-M3-015: 리마인드 대상 없음 처리**
- **Given:** 모임 3일 전이지만 confirmed 상태 참가자 0명
- **When:** 리마인드 Cron 실행
- **Then:** 알림 발송 없음, 오류 없이 정상 종료
- **선행:** SC-M3-010

#### 사용자 가치
> "사용자가 모임 전에 자동으로 리마인드 알림을 받아 잊지 않는다"

---

### Phase 3: 대기자 & 세그먼트 알림

**목표:** 대기자 자리 발생 알림과 세그먼트별 리마인드가 동작한다
**예상 소요:** 3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | 대기자 자리 발생 알림 | 알림 함수 | 취소 시 1순위 대기자에게 알림 |
| 3.2 | 대기자 응답 대기 시간 설정 | 비즈니스 로직 | 24시간/6시간/2시간 |
| 3.3 | 응답 시간 초과 체크 Cron | 스케줄러 | 미응답 시 다음 대기자 |
| 3.4 | 월말 참여 독려 알림 | 알림 함수 | 이번 달 미참여 회원 대상 |
| 3.5 | 온보딩 이탈 위험 알림 | 알림 함수 | 신규 가입 후 미참여 |
| 3.6 | 휴면 위험 알림 | 알림 함수 | 3개월 이상 미참여 |
| 3.7 | 자격 만료 임박 알림 | 알림 함수 | 정기모임 자격 만료 예정 |
| 3.8 | 세그먼트 분류 로직 | DB 쿼리/뷰 | 회원 세그먼트 판별 |

#### Scenario (검증 기준)

**🔴 SC-M3-020: 대기자 자리 발생 알림**
- **Given:** 모임 정원 마감, 대기자 A(1순위), B(2순위) 존재
- **When:** 참가자 1명 취소 처리 완료
- **Then:** 1순위 대기자 A에게만 "자리가 났습니다" 알림 발송
- **선행:** SC-M3-001

**🟡 SC-M3-021: 대기자 없을 때 취소 처리**
- **Given:** 모임에 대기자 0명
- **When:** 참가자 1명 취소 처리 완료
- **Then:** 대기자 알림 발송 없음, 정원만 복구
- **선행:** SC-M3-020

**🔴 SC-M3-022: 대기자 응답 시간 (D-3 이상) - 24시간 초과**
- **Given:** 모임 4일 전, 대기자 A에게 알림 발송 후 24시간 경과, 미응답
- **When:** 응답 시간 초과 체크 Cron 실행
- **Then:** 대기자 A 만료 처리, 대기자 B에게 알림 발송
- **선행:** SC-M3-020

**🟡 SC-M3-023: 대기자 응답 시간 (D-2) - 6시간 초과**
- **Given:** 모임 2일 전, 대기자 A에게 알림 발송 후 6시간 경과, 미응답
- **When:** 응답 시간 초과 체크 Cron 실행
- **Then:** 대기자 A 만료 처리, 다음 대기자에게 알림 발송
- **선행:** SC-M3-020

**🟡 SC-M3-024: 대기자 응답 시간 (D-1) - 2시간 초과**
- **Given:** 모임 1일 전, 대기자 A에게 알림 발송 후 2시간 경과, 미응답
- **When:** 응답 시간 초과 체크 Cron 실행
- **Then:** 대기자 A 만료 처리, 다음 대기자에게 알림 발송
- **선행:** SC-M3-020

**🟡 SC-M3-025: 대기자가 응답 시간 내 결제 완료**
- **Given:** 대기자 A에게 자리 발생 알림 발송됨, 응답 시간 내
- **When:** 대기자 A가 결제 완료
- **Then:** 대기자 A가 confirmed 상태로 전환, 다음 대기자 알림 없음
- **선행:** SC-M3-020

**🔴 SC-M3-026: 월말 참여 독려 알림**
- **Given:** 월말(25~31일), 이번 달 confirmed 모임 0건인 회원 존재
- **When:** 월말 알림 Cron 실행
- **Then:** "[닉네임]님, 이번 달 아직 모임이 없어요" 알림 발송
- **선행:** SC-M3-001

**🟡 SC-M3-027: 월말 알림 대상 제외 - 이미 참여 예정**
- **Given:** 월말, 회원 A는 이번 달 confirmed 모임 1건 존재
- **When:** 월말 알림 Cron 실행
- **Then:** 회원 A에게 알림 발송하지 않음
- **선행:** SC-M3-026

**🟡 SC-M3-028: 온보딩 이탈 위험 알림**
- **Given:** 가입 후 45일 경과, 첫 정기모임 참여 완료 후 두 번째 참여 없음
- **When:** 세그먼트 알림 Cron 실행
- **Then:** 복귀 유도 알림 발송
- **선행:** SC-M3-001

**🟢 SC-M3-029: 휴면 위험 알림**
- **Given:** 마지막 참여 완료 후 3개월 경과
- **When:** 세그먼트 알림 Cron 실행
- **Then:** 휴면 위험 복귀 유도 알림 발송
- **선행:** SC-M3-001

**🟢 SC-M3-030: 자격 만료 임박 알림**
- **Given:** 마지막 정기모임 참여 완료 후 5개월 경과
- **When:** 세그먼트 알림 Cron 실행
- **Then:** "정기모임 자격이 곧 만료됩니다" 긴급 알림 발송
- **선행:** SC-M3-001

#### 사용자 가치
> "대기자가 자리 발생 즉시 알림을 받고, 미참여 회원이 리마인드를 받는다"

---

### Phase 4: 운영자 알림 관리

**목표:** 운영자가 알림을 수동 발송하고 관리할 수 있다
**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | 수동 알림 발송 UI | 운영자 페이지 | 대상 선택 + 메시지 입력 |
| 4.2 | 수동 알림 발송 API | `app/api/admin/` | 알림 발송 처리 |
| 4.3 | 발송 대상 선택 기능 | UI | 전체/모임별/개인 |
| 4.4 | 알림 발송 이력 조회 | 운영자 페이지 | notification_logs 조회 |
| 4.5 | 발송 실패 재시도 기능 | UI | 실패 건 재발송 |

#### Scenario (검증 기준)

**🔴 SC-M3-040: 수동 알림 발송 - 전체 회원**
- **Given:** 운영자 로그인, 알림 관리 페이지 진입
- **When:** 대상 "전체 회원" 선택 -> 메시지 입력 -> 발송 버튼 클릭
- **Then:** 전체 회원에게 알림 발송, notification_logs에 이력 저장
- **선행:** SC-M3-001

**🔴 SC-M3-041: 수동 알림 발송 - 특정 모임 참가자**
- **Given:** 운영자 로그인, 알림 관리 페이지 진입
- **When:** 대상 "특정 모임" 선택 -> 모임 선택 -> 메시지 입력 -> 발송
- **Then:** 해당 모임 confirmed 참가자에게만 알림 발송
- **선행:** SC-M3-040

**🟡 SC-M3-042: 수동 알림 발송 - 개인**
- **Given:** 운영자 로그인, 알림 관리 페이지 진입
- **When:** 대상 "개인" 선택 -> 회원 검색/선택 -> 메시지 입력 -> 발송
- **Then:** 선택된 개인에게만 알림 발송
- **선행:** SC-M3-040

**🟡 SC-M3-043: 수동 알림 발송 실패 - 메시지 미입력**
- **Given:** 운영자 로그인, 알림 관리 페이지 진입, 대상 선택 완료
- **When:** 메시지 입력 없이 발송 버튼 클릭
- **Then:** "메시지를 입력해주세요" 오류 표시, 발송 안됨
- **선행:** SC-M3-040

**🔴 SC-M3-044: 알림 이력 조회**
- **Given:** 알림 발송 이력 10건 존재
- **When:** 알림 이력 페이지 진입
- **Then:** 발송 일시, 대상(전체/모임명/개인명), 성공/실패 여부 목록 표시
- **선행:** SC-M3-040

**🟡 SC-M3-045: 알림 이력 필터링**
- **Given:** 알림 발송 이력 중 성공 7건, 실패 3건 존재
- **When:** "실패만 보기" 필터 적용
- **Then:** 실패 3건만 표시
- **선행:** SC-M3-044

**🟡 SC-M3-046: 발송 실패 재시도**
- **Given:** 발송 실패 건 존재 (status="failed")
- **When:** 해당 건의 "재시도" 버튼 클릭
- **Then:** 알림 재발송 시도, 결과에 따라 상태 업데이트
- **선행:** SC-M3-044

**🟡 SC-M3-047: 비운영자 알림 관리 접근 차단**
- **Given:** 일반 회원 로그인 상태
- **When:** /admin/notifications 페이지 직접 접근 시도
- **Then:** 403 Forbidden 또는 홈으로 리다이렉트
- **선행:** 없음

#### 사용자 가치
> "운영자가 필요시 수동으로 알림을 발송하고 발송 이력을 관리할 수 있다"

---

## 3. 기술 검토 사항

| 항목 | 내용 | 참고 |
|------|------|------|
| 솔라피 API | 알림톡 발송 | 솔라피 문서 |
| 카카오 알림톡 | 템플릿 사전 승인 필요 | 카카오 비즈니스 |
| 스케줄러 | Vercel Cron (무료 플랜 제한 확인) 또는 pg_cron | Vercel/Supabase 문서 |
| 서비스 추상화 | Strategy 패턴 적용 | 디자인 패턴 |
| 중복 방지 | notification_logs에 unique 제약 | DB 설계 |

---

## 4. 전체 완료 검증

- [ ] Phase 1: 알림 인프라 구축 완료
- [ ] Phase 2: 모임 리마인드 알림 완료
- [ ] Phase 3: 대기자 & 세그먼트 알림 완료
- [ ] Phase 4: 운영자 알림 관리 완료
- [ ] 모든 Scenario 통과
- [ ] 실제 알림톡 수신 테스트 완료
- [ ] main 머지 완료

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-29 | 1.0 | WP-M3 최초 작성 |
