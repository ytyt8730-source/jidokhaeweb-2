# Work Package: M4 - PG 결제 & 소속감

**Milestone:** M4
**목표:** 사용자가 간편결제로 신청하고, 커뮤니티 소속감 기능을 사용할 수 있다
**기간:** 3주
**선행 조건:** M2 완료, PG 심사 완료

---

## 1. Work Package 개요

```
Phase 1: PG 결제 연동
    ↓
Phase 2: 자동 환불 시스템
    ↓
Phase 3: 참여 완료 & 칭찬하기
    ↓
Phase 4: 배지 & 후기 시스템
    ↓
Phase 5: 마이페이지 확장 & 내 책장
```

**수직 분할 원칙:** 각 Phase 완료 시 결제 또는 소속감 관련 기능이 독립적으로 동작

---

## 2. Phase 상세

### Phase 1: PG 결제 연동

**목표:** 사용자가 카카오페이/토스로 간편결제할 수 있다
**예상 소요:** 4~5일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 포트원 V2 SDK 설치 | `package.json` | 설치 완료 |
| 1.2 | 포트원 설정 (카카오페이) | 환경 변수 | API 키 설정 |
| 1.3 | 포트원 설정 (토스페이먼츠) | 환경 변수 | API 키 설정 |
| 1.4 | payments 테이블 생성 | DB 스키마 | 결제 데이터 저장 |
| 1.5 | 결제 수단 선택 UI | 신청 모달 | 카카오페이/토스/계좌이체 |
| 1.6 | 결제 요청 API | `app/api/payments/` | 포트원 결제 요청 |
| 1.7 | 결제 완료 웹훅 수신 | `app/api/webhooks/` | 결제 결과 수신 |
| 1.8 | 웹훅 검증 로직 | API | 서명 검증 |
| 1.9 | 결제 성공 시 confirmed 처리 | 비즈니스 로직 | 즉시 확정 |
| 1.10 | 결제 실패 처리 | 에러 핸들링 | 실패 안내 |
| 1.11 | 결제 내역 저장 | DB | payments 테이블 기록 |

#### Scenario (검증 기준)

**🔴 SC-M4-001: 카카오페이 결제 성공**
- **Given:** 로그인 상태, 모임 상세 페이지에서 "신청하기" 클릭
- **When:** 카카오페이 선택 -> 결제 앱에서 결제 완료
- **Then:** 즉시 confirmed 상태, 마이페이지에서 "신청완료" 표시, payments 테이블에 기록
- **선행:** 없음

**🔴 SC-M4-002: 토스페이먼츠 결제 성공**
- **Given:** 로그인 상태, 모임 상세 페이지에서 "신청하기" 클릭
- **When:** 토스 선택 -> 결제 앱에서 결제 완료
- **Then:** 즉시 confirmed 상태, 마이페이지에서 "신청완료" 표시, payments 테이블에 기록
- **선행:** 없음

**🔴 SC-M4-003: 결제 웹훅 정상 처리**
- **Given:** 사용자가 결제 완료, 포트원에서 웹훅 발송
- **When:** /api/webhooks/portone 엔드포인트에서 웹훅 수신
- **Then:** HMAC 서명 검증 성공, application 상태를 confirmed로 업데이트
- **선행:** SC-M4-001

**🟡 SC-M4-004: 웹훅 서명 검증 실패**
- **Given:** 잘못된 서명을 가진 웹훅 요청
- **When:** /api/webhooks/portone 엔드포인트에서 웹훅 수신
- **Then:** 401 Unauthorized 반환, 상태 변경 없음, 보안 로그 기록
- **선행:** SC-M4-003

**🟡 SC-M4-005: 결제 실패 - 잔액 부족**
- **Given:** 결제 진행 중
- **When:** 결제 실패 (잔액 부족)
- **Then:** "결제에 실패했습니다. 잔액을 확인해주세요" 메시지 표시, application 생성 안됨
- **선행:** SC-M4-001

**🟡 SC-M4-006: 결제 실패 - 사용자 취소**
- **Given:** 결제 앱으로 이동 후
- **When:** 사용자가 결제 취소
- **Then:** "결제가 취소되었습니다" 메시지 표시, 모임 상세 페이지로 복귀
- **선행:** SC-M4-001

**🟡 SC-M4-007: 결제 수단 선택 UI**
- **Given:** 신청 모달 오픈
- **When:** 결제 수단 선택 영역 표시
- **Then:** 카카오페이, 토스페이먼츠, 계좌이체 3가지 옵션 표시
- **선행:** 없음

**🟢 SC-M4-008: 정원 마감 시 결제 차단**
- **Given:** 모임 정원 14명 중 14명 confirmed
- **When:** 15번째 사용자가 "신청하기" 클릭
- **Then:** "정원이 마감되었습니다. 대기 신청하시겠습니까?" 안내 표시
- **선행:** SC-M4-001

#### 사용자 가치
> "사용자가 카카오페이/토스로 간편하게 결제하여 즉시 참가 확정된다"

---

### Phase 2: 자동 환불 시스템

**목표:** 취소 시 환불 규정에 따라 자동으로 환불된다
**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | 환불 규정 조회 함수 | `lib/refund.ts` | 규정 계산 |
| 2.2 | 환불 금액 자동 계산 | 비즈니스 로직 | D-5, D-2 기준 |
| 2.3 | 취소 시 환불 금액 표시 | 취소 모달 | 예상 환불액 안내 |
| 2.4 | 포트원 부분 환불 API 연동 | API | 환불 요청 |
| 2.5 | 전액 환불 처리 | API | 100% 환불 |
| 2.6 | 부분 환불 처리 | API | 수수료 제외 환불 |
| 2.7 | refunds 테이블 생성 | DB 스키마 | 환불 기록 |
| 2.8 | 환불 완료 기록 | DB | 환불 내역 저장 |
| 2.9 | 환불 상태 표시 | 마이페이지 | 환불 진행/완료 |

#### Scenario (검증 기준)

**SC-M4-006: 전액 환불 (D-5 이전)** [Critical]
- Given: 모임 5일 전 이상, PG 결제 완료 상태
- When: 취소 요청
- Then: 100% 자동 환불 처리

**SC-M4-007: 부분 환불 (D-5 ~ D-2)** [Critical]
- Given: 모임 5일~2일 전, PG 결제 완료 상태
- When: 취소 요청
- Then: 규정에 따른 부분 환불 (예: 50%)

**SC-M4-008: 환불 불가 (D-2 이내)** [Critical]
- Given: 모임 2일 이내, PG 결제 완료 상태
- When: 취소 요청
- Then: 환불 불가 안내, 취소만 처리

**SC-M4-009: 환불 금액 사전 안내** [High]
- Given: 취소 모달 오픈
- When: 환불 규정 조회
- Then: 예상 환불 금액 표시 (예: "10,000원 중 5,000원 환불 예정")

**SC-M4-010: 계좌이체 취소 시 수동 환불** [High]
- Given: 계좌이체로 결제한 경우
- When: 취소 요청
- Then: 환불 계좌 입력 폼 표시, 수동 환불 처리 안내

#### 사용자 가치
> "사용자가 취소하면 규정에 따라 자동으로 환불받아 운영자 개입 없이 처리된다"

---

### Phase 3: 참여 완료 & 칭찬하기

**목표:** 모임 후 참여 확인 및 칭찬 기능이 동작한다
**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | 모임 종료 체크 로직 | Cron | 종료 시점 판별 |
| 3.2 | 종료 3일 후 "어떠셨어요?" 알림 | 알림 함수 | 알림 발송 |
| 3.3 | 참여 완료 페이지 | `app/meetings/[id]/complete/` | 선택 화면 |
| 3.4 | [칭찬하기] 버튼 | 참여 완료 UI | 칭찬 플로우 진입 |
| 3.5 | [참여했어요] 버튼 | 참여 완료 UI | 단순 확인 |
| 3.6 | [후기 남기기] 버튼 | 참여 완료 UI | 후기 플로우 진입 |
| 3.7 | 7일 미응답 시 자동 완료 | Cron | 상태 자동 변경 |
| 3.8 | praises 테이블 생성 | DB 스키마 | 칭찬 데이터 |
| 3.9 | 칭찬하기 UI | 참여 완료 페이지 | 참가자 닉네임 목록에서 선택 |
| 3.10 | 익명 칭찬 저장 | API | 칭찬 기록 |
| 3.11 | 모임당 1명 제한 로직 | 비즈니스 로직 | 중복 방지 |
| 3.12 | 3개월 내 동일인 제한 | 비즈니스 로직 | 연속 칭찬 방지 |
| 3.13 | 누적 칭찬 수 표시 | 프로필/마이페이지 | 칭찬 횟수 |

#### Scenario (검증 기준)

**SC-M4-011: 참여 완료 알림** [Critical]
- Given: 모임 종료 후 3일 경과
- When: Cron 실행
- Then: 참가자에게 "어떠셨어요?" 알림 발송

**SC-M4-012: 칭찬하기** [Critical]
- Given: 참여 완료 페이지에서 "칭찬하기" 선택
- When: 참가자 닉네임 목록에서 1명 선택 후 칭찬 제출
- Then: 익명 칭찬 저장, 상대방 칭찬 수 +1

**SC-M4-013: 모임당 1명 칭찬 제한** [High]
- Given: 이미 해당 모임에서 칭찬함
- When: 다시 칭찬 시도
- Then: "이미 칭찬하셨습니다" 안내

**SC-M4-014: 3개월 동일인 칭찬 제한** [High]
- Given: 3개월 내 동일인 칭찬 이력
- When: 같은 사람 칭찬 시도
- Then: 해당 회원 선택 불가 또는 안내

**SC-M4-015: 7일 미응답 자동 완료** [High]
- Given: 참여 완료 알림 후 7일 경과, 미응답
- When: Cron 실행
- Then: 자동으로 "참여 완료" 처리

**SC-M4-016: 누적 칭찬 수 표시** [Medium]
- Given: 칭찬 받은 회원
- When: 마이페이지 또는 프로필 조회
- Then: 누적 칭찬 수 표시

#### 사용자 가치
> "사용자가 모임 후 참여를 확인하고, 좋았던 멤버를 칭찬할 수 있다"

---

### Phase 4: 배지 & 후기 시스템

**목표:** 배지 시스템과 후기 기능이 동작한다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | badges 테이블 생성 | DB 스키마 | 배지 정의 |
| 4.2 | user_badges 테이블 생성 | DB 스키마 | 획득 배지 |
| 4.3 | 배지 정의 (첫 참여, 5회, 10회 등) | 시드 데이터 | 배지 목록 |
| 4.4 | 배지 자동 부여 로직 | 트리거/함수 | 조건 충족 시 자동 |
| 4.5 | 배지 표시 UI | 마이페이지 | 획득 배지 목록 |
| 4.6 | 새 배지 획득 알림 | 알림 | 배지 획득 시 |
| 4.7 | reviews 테이블 생성 | DB 스키마 | 후기/건의 |
| 4.8 | 후기 작성 UI | 참여 완료 페이지 | 텍스트 입력 |
| 4.9 | 후기 저장 API | API | 후기 기록 |
| 4.10 | 공개 동의 체크박스 | 후기 UI | 동의 여부 |

#### Scenario (검증 기준)

**SC-M4-017: 첫 참여 배지** [Critical]
- Given: 첫 모임 참여 완료
- When: 참여 완료 처리
- Then: "첫 발자국" 배지 자동 부여

**SC-M4-018: 참여 횟수 배지** [High]
- Given: 10회 참여 완료
- When: 10번째 참여 완료 처리
- Then: "10회 참여" 배지 자동 부여

**SC-M4-019: 배지 목록 조회** [High]
- Given: 배지 획득 이력
- When: 마이페이지 배지 섹션 조회
- Then: 획득한 배지 목록 표시

**SC-M4-020: 후기 작성** [Critical]
- Given: 참여 완료 페이지
- When: "후기 남기기" -> 텍스트 입력 -> 제출
- Then: 후기 저장, 공개 동의 여부 기록

**SC-M4-021: 후기 공개 동의** [High]
- Given: 후기 작성 중
- When: "공개 동의" 체크 후 제출
- Then: 후킹페이지에서 표시 가능 상태로 저장

#### 사용자 가치
> "사용자가 배지를 획득하며 성취감을 느끼고, 후기를 남길 수 있다"

---

### Phase 5: 마이페이지 확장 & 내 책장

**목표:** 마이페이지 통계와 내 책장 기능이 동작한다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 5.1 | 총 참여 횟수 계산 | 통계 쿼리 | 정확한 수치 |
| 5.2 | 연속 참여 횟수 계산 | 통계 쿼리 | 연속 월 카운트 |
| 5.3 | "함께한 지 OOO일째" 계산 | 통계 쿼리 | 첫 참여일 기준 |
| 5.4 | 마이페이지 통계 섹션 | UI | 통계 표시 |
| 5.5 | user_books 테이블 생성 | DB 스키마 | 책 기록 |
| 5.6 | 내 책장 페이지 | `app/mypage/bookshelf/` | 책 목록 |
| 5.7 | 책 등록 UI | 내 책장 | 제목/저자 입력 |
| 5.8 | 한 문장 기록 기능 | 책 상세 | 감상 문장 저장 |
| 5.9 | 모임 참여 책 자동 추가 | 비즈니스 로직 | 참여 완료 시 |

#### Scenario (검증 기준)

**SC-M4-022: 참여 통계 표시** [Critical]
- Given: 여러 번 참여한 회원
- When: 마이페이지 조회
- Then: 총 참여 횟수, 연속 참여, "함께한 지 OOO일째" 정확히 표시

**SC-M4-023: 내 책장 조회** [High]
- Given: 참여 완료된 모임 책 존재
- When: 내 책장 페이지 진입
- Then: 참여한 모임의 책 목록 표시

**SC-M4-024: 한 문장 기록** [High]
- Given: 내 책장에서 책 선택
- When: 한 문장 입력 후 저장
- Then: 해당 책에 감상 문장 저장됨

**SC-M4-025: 수동 책 등록** [Medium]
- Given: 내 책장 페이지
- When: "책 추가" -> 제목/저자 입력 -> 저장
- Then: 새 책이 책장에 추가됨

#### 사용자 가치
> "사용자가 자신의 참여 기록을 확인하고, 읽은 책을 기록할 수 있다"

---

## 3. 기술 검토 사항

| 항목 | 내용 | 참고 |
|------|------|------|
| 포트원 V2 | 결제/환불 API | 포트원 문서 |
| 웹훅 검증 | HMAC 서명 검증 | 포트원 보안 가이드 |
| 부분 환불 | cancel API의 amount 파라미터 | 포트원 환불 API |
| 환불 규정 | DB에서 관리 (하드코딩 금지) | refund_policies 테이블 |
| 배지 자동 부여 | PostgreSQL 트리거 또는 App 레벨 | 성능 고려 |

---

## 4. 전체 완료 검증

- [ ] Phase 1: PG 결제 연동 완료
- [ ] Phase 2: 자동 환불 시스템 완료
- [ ] Phase 3: 참여 완료 & 칭찬하기 완료
- [ ] Phase 4: 배지 & 후기 시스템 완료
- [ ] Phase 5: 마이페이지 확장 & 내 책장 완료
- [ ] 모든 Scenario 통과
- [ ] 실제 PG 결제/환불 테스트 완료 (테스트 모드)
- [ ] main 머지 완료

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-29 | 1.0 | WP-M4 최초 작성 |
