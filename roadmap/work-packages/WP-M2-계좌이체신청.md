# Work Package: M2 - 계좌이체 신청 & Beta 오픈

**Milestone:** M2
**목표:** 사용자가 계좌이체로 모임에 신청하고, 운영자가 입금을 확인할 수 있다
**기간:** 2주
**선행 조건:** M1 완료

---

## 1. Work Package 개요

```
Phase 1: 카카오 로그인 & 신청 기반
    ↓
Phase 2: 계좌이체 신청 플로우
    ↓
Phase 3: 운영자 입금 확인
    ↓
Phase 4: 취소/환불 & 대기 시스템
    ↓
Phase 5: 마이페이지 신청 내역
```

**수직 분할 원칙:** 각 Phase 완료 시 Beta 오픈에 필요한 기능이 점진적으로 추가됨

---

## 2. Phase 상세

### Phase 1: 카카오 로그인 & 신청 기반

**목표:** 카카오 로그인이 가능하고 신청 데이터 구조가 준비됨
**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | Supabase 카카오 OAuth 설정 | Supabase Auth 설정 | 카카오 앱 연동 |
| 1.2 | 카카오 로그인 버튼 UI | 로그인 페이지 | 버튼 렌더링 |
| 1.3 | 카카오 로그인 API 연동 | Auth 서비스 | 로그인 성공 |
| 1.4 | 카카오 콜백 처리 | `app/auth/callback/` | 리다이렉트 처리 |
| 1.5 | registrations 테이블 생성 | DB 스키마 | 신청 데이터 저장 |
| 1.6 | 신청 상태 enum 정의 | DB 스키마 | pending_transfer, confirmed, cancelled 등 |
| 1.7 | RLS 정책 (registrations) | Supabase | 본인 신청만 조회 |

#### Scenario (검증 기준)

**SC-M2-001: 카카오 로그인 성공** [Critical]
- **Given:** 로그인 페이지
- **When:** 카카오 로그인 버튼 클릭 후 카카오 인증 완료
- **Then:** 홈 화면으로 이동, 사용자 정보 표시
- **선행:** 없음

**SC-M2-001-1: 카카오 로그인 취소** [High]
- **Given:** 카카오 인증 페이지
- **When:** 사용자가 인증 취소
- **Then:** 로그인 페이지로 복귀, 에러 메시지 없음
- **선행:** 없음

**SC-M2-001-2: 카카오 로그인 실패 - 콜백 에러** [High]
- **Given:** 카카오 인증 완료 후 콜백
- **When:** 콜백 처리 중 에러 발생
- **Then:** 로그인 페이지로 리다이렉트, "로그인에 실패했습니다" 메시지 표시
- **선행:** 없음

**SC-M2-001-3: 카카오 신규 가입 - 닉네임 설정** [Critical]
- **Given:** 카카오 첫 로그인 (계정 없음)
- **When:** 카카오 인증 완료
- **Then:** 닉네임 설정 페이지로 이동 (또는 닉네임 입력 모달 표시)
- **선행:** SC-M2-001

**SC-M2-002: 신청 데이터 구조 검증** [High]
- **Given:** registrations 테이블 생성 완료
- **When:** 테스트 데이터 삽입
- **Then:** 상태(pending_transfer, confirmed, cancelled, expired, waiting) 저장됨
- **선행:** 없음

**SC-M2-002-1: RLS 정책 - 본인 신청만 조회** [Critical]
- **Given:** 사용자 A의 신청 데이터 존재
- **When:** 사용자 B가 신청 목록 조회
- **Then:** 사용자 A의 신청은 조회되지 않음
- **선행:** SC-M2-002

#### 사용자 가치
> "사용자가 카카오 계정으로 쉽게 로그인할 수 있다"

---

### Phase 2: 계좌이체 신청 플로우

**목표:** 사용자가 계좌이체 방식으로 모임에 신청할 수 있다
**예상 소요:** 3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | 신청하기 버튼 활성화 | 모임 상세 페이지 | 버튼 클릭 가능 |
| 2.2 | 정원 확인 로직 | API | 정원 초과 시 비활성화 |
| 2.3 | 계좌 정보 표시 UI | 신청 모달 | 은행/계좌번호/예금주 |
| 2.4 | 클립보드 복사 기능 | 계좌 UI | 복사 버튼 동작 |
| 2.5 | 입금자명 입력 폼 | 신청 모달 | "MMDD_실명" 안내 ※ 은행 입금자명 매칭 필요, 닉네임 아님 |
| 2.6 | 입금자명 정규식 검증 | 입력 폼 | 형식 오류 시 안내 |
| 2.7 | "입금했습니다" 버튼 | 신청 모달 | 클릭 시 신청 생성 |
| 2.8 | 정원 예약 로직 (동시성) | API | 정원 즉시 예약 |
| 2.9 | pending_transfer 상태 저장 | DB | 신청 상태 저장 |
| 2.10 | 48시간 만료 시간 기록 | DB | deposit_deadline 저장 |
| 2.11 | 참가 인원 실시간 반영 | 모임 카드/상세 | "O명 참여" 업데이트 |

#### Scenario (검증 기준)

**SC-M2-003: 계좌이체 신청** [Critical]
- Given: 정원이 남은 모임 상세 페이지
- When: "신청하기" -> 입금자명 입력 -> "입금했습니다" 클릭
- Then: 신청 생성, 정원 예약, 마이페이지에서 "입금대기" 표시

**SC-M2-004: 계좌번호 복사** [High]
- Given: 신청 모달에서 계좌 정보 표시
- When: 복사 버튼 클릭
- Then: 클립보드에 계좌번호 복사, 토스트 메시지 표시

**SC-M2-005: 입금자명 형식 검증** [High]
- Given: 입금자명 입력 중
- When: "0128_홍길동" 형식이 아닌 값 입력
- Then: 에러 메시지 표시, 제출 불가
- Note: 입금자명은 은행 실명과 매칭해야 하므로 닉네임이 아닌 실명 사용

**SC-M2-006: 정원 초과 방지** [Critical]
- Given: 정원 10명, 현재 9명 신청
- When: 2명이 동시에 신청 시도
- Then: 1명만 성공, 1명은 정원 마감 메시지

**SC-M2-007: 정원 마감 표시** [High]
- Given: 정원이 가득 찬 모임
- When: 상세 페이지 진입
- Then: "마감" 뱃지 표시, 신청 버튼 비활성화

#### 사용자 가치
> "사용자가 계좌이체 방식으로 모임 참가를 신청할 수 있다"

---

### Phase 3: 운영자 입금 확인

**목표:** 운영자가 입금을 확인하고 참가를 확정할 수 있다
**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | 운영자 권한 체크 | 미들웨어 | admin 역할 확인 |
| 3.2 | 입금 확인 목록 페이지 | `app/admin/deposits/` | pending_transfer 목록 |
| 3.3 | 신청자 정보 표시 | 목록 UI | 실명, 닉네임, 입금자명, 신청일 |
| 3.4 | "입금 확인" 버튼 | 목록 UI | 개별 확인 가능 |
| 3.5 | 입금 확인 API | `app/api/admin/` | 상태 변경 처리 |
| 3.6 | confirmed 상태 변경 | DB | 신청 상태 업데이트 |
| 3.7 | 확정 시간 기록 | DB | confirmed_at 저장 |
| 3.8 | 48시간 미입금 자동 만료 | Cron/Edge Function | deposit_deadline 체크 후 만료 |

#### Scenario (검증 기준)

**SC-M2-008: 입금 확인 목록 조회** [Critical]
- Given: 운영자 로그인
- When: 입금 확인 페이지 진입
- Then: pending_transfer 상태 신청 목록 표시

**SC-M2-009: 입금 확인 처리** [Critical]
- Given: 입금 확인 목록에서 신청 선택
- When: "입금 확인" 버튼 클릭
- Then: 상태가 confirmed로 변경, 목록에서 제거

**SC-M2-010: 48시간 미입금 만료** [Critical]
- Given: pending_transfer 상태로 48시간 경과
- When: Cron 작업 실행
- Then: 상태가 expired로 변경, 정원 반환

**SC-M2-011: 비운영자 접근 차단** [High]
- Given: 일반 사용자 로그인
- When: 운영자 페이지 접근 시도
- Then: 403 에러 또는 리다이렉트

#### 사용자 가치
> "운영자가 입금 여부를 확인하고 참가를 확정할 수 있다"

---

### Phase 4: 취소/환불 & 대기 시스템

**목표:** 사용자가 취소하고 환불 계좌를 등록할 수 있으며, 대기 신청이 가능하다
**예상 소요:** 3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | 취소 요청 UI | 마이페이지 | 취소 버튼 표시 |
| 4.2 | 취소 사유 입력 폼 | 취소 모달 | 선택/직접입력 |
| 4.3 | 환불 계좌 입력 폼 | 취소 모달 | 은행/계좌/예금주 |
| 4.4 | 취소 API | `app/api/registrations/` | 상태 변경 |
| 4.5 | cancelled 상태 저장 | DB | 환불 계좌 정보 포함 |
| 4.6 | 정원 반환 로직 | API | 취소 시 정원 복구 |
| 4.7 | 대기 등록 기능 | 모임 상세 | 정원 초과 시 대기 |
| 4.8 | waitlists 테이블 저장 | DB | 대기 순번 기록 |
| 4.9 | 대기자 목록 관리 (운영자) | 관리자 페이지 | 대기자 조회 |
| 4.10 | 취소 발생 알림 메모 | 운영자 UI | 수동 알림 안내 (M3에서 자동화) |

#### Scenario (검증 기준)

**SC-M2-012: 참가 취소 요청** [Critical]
- Given: confirmed 상태의 신청
- When: "취소하기" -> 사유 입력 -> 환불 계좌 입력 -> 확인
- Then: 상태가 cancelled로 변경, 환불 계좌 저장

**SC-M2-013: 취소 시 정원 반환** [Critical]
- Given: 정원 10명, 10명 확정
- When: 1명이 취소
- Then: 참가 인원 9명으로 감소, 신청 버튼 활성화

**SC-M2-014: 대기 등록** [Critical]
- Given: 정원이 가득 찬 모임
- When: "대기 신청" 클릭
- Then: waiting 상태로 등록, 대기 순번 표시

**SC-M2-015: 대기자 목록 조회 (운영자)** [High]
- Given: 운영자 로그인, 대기자 존재
- When: 대기자 관리 페이지 진입
- Then: 대기자 목록 순번별 표시

#### 사용자 가치
> "사용자가 참가를 취소하고, 정원 초과 시 대기 신청을 할 수 있다"

---

### Phase 5: 마이페이지 신청 내역

**목표:** 사용자가 본인의 신청 내역과 상태를 확인할 수 있다
**예상 소요:** 2일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 5.1 | 신청 내역 섹션 | 마이페이지 | 내역 목록 표시 |
| 5.2 | 상태별 뱃지 표시 | 신청 내역 UI | 입금대기/완료/취소 |
| 5.3 | 신청 상세 정보 | 내역 카드 | 모임명, 일시, 금액 |
| 5.4 | 입금대기 상태 안내 | 내역 UI | 남은 시간 표시 |
| 5.5 | 취소 버튼 조건부 표시 | 내역 UI | 모임 전만 취소 가능 |
| 5.6 | 마감 임박/마감 상태 표시 | 모임 카드 | 상태 뱃지 |

#### Scenario (검증 기준)

**SC-M2-016: 신청 내역 조회** [Critical]
- Given: 로그인 후 신청 내역 존재
- When: 마이페이지 진입
- Then: 모든 신청 내역이 상태별로 표시

**SC-M2-017: 입금대기 상태 표시** [High]
- Given: pending_transfer 상태 신청
- When: 마이페이지에서 확인
- Then: "입금대기" 뱃지, 남은 시간(XX시간 XX분) 표시

**SC-M2-018: 신청완료 상태 표시** [High]
- Given: confirmed 상태 신청
- When: 마이페이지에서 확인
- Then: "신청완료" 뱃지 표시

**SC-M2-019: 취소됨 상태 표시** [High]
- Given: cancelled 상태 신청
- When: 마이페이지에서 확인
- Then: "취소됨" 뱃지 표시, 환불 진행 안내

#### 사용자 가치
> "사용자가 본인의 모든 신청 내역과 상태를 한눈에 확인할 수 있다"

---

## 3. 기술 검토 사항

| 항목 | 내용 | 참고 |
|------|------|------|
| 카카오 OAuth | Supabase Auth Provider | Supabase 문서 |
| 동시성 제어 | SELECT ... FOR UPDATE 또는 트랜잭션 | PostgreSQL |
| 48시간 만료 | Vercel Cron 또는 pg_cron | 스케줄러 문서 |
| RLS 정책 | registrations: 본인만 조회, 운영자 전체 조회 | Supabase RLS |
| 입금자명 정규식 | `/^\d{4}_[가-힣]+$/` | - |

---

## 4. 전체 완료 검증

- [ ] Phase 1: 카카오 로그인 & 신청 기반 완료
- [ ] Phase 2: 계좌이체 신청 플로우 완료
- [ ] Phase 3: 운영자 입금 확인 완료
- [ ] Phase 4: 취소/환불 & 대기 시스템 완료
- [ ] Phase 5: 마이페이지 신청 내역 완료
- [ ] 모든 Scenario 통과
- [ ] **실제 회원에게 링크를 줘서 신청을 받을 수 있음** (Beta 오픈 기준)
- [ ] main 머지 완료

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-29 | 1.0 | WP-M2 최초 작성 |
