# Work Package: M5 - 운영 고도화

**Milestone:** M5
**목표:** 운영자가 대시보드에서 모든 현황을 파악하고 효율적으로 관리할 수 있다
**기간:** 2주
**선행 조건:** M3, M4 완료

---

## 1. Work Package 개요

```
Phase 1: 운영 대시보드
    ↓
Phase 2: 권한 관리 시스템
    ↓
Phase 3: 알림 & 콘텐츠 관리
    ↓
Phase 4: 회원 & 예외 처리
```

**수직 분할 원칙:** 각 Phase 완료 시 운영자가 사용할 수 있는 관리 기능이 추가됨

---

## 2. Phase 상세

### Phase 1: 운영 대시보드

**목표:** 운영자가 이번 달 현황을 한눈에 파악할 수 있다
**예상 소요:** 3~4일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 1.1 | 대시보드 레이아웃 | `app/admin/page.tsx` | 기본 구조 |
| 1.2 | 이번 달 참가 현황 카드 | 대시보드 UI | 총 참가자 수 |
| 1.3 | 이번 달 수입 카드 | 대시보드 UI | 총 결제 금액 |
| 1.4 | 이번 달 환불 내역 카드 | 대시보드 UI | 환불 건수/금액 |
| 1.5 | 세그먼트별 회원 수 | 대시보드 UI | 신규/활성/휴면 등 |
| 1.6 | 재참여율 통계 | 대시보드 UI | 월별 재참여율 |
| 1.7 | 통계 데이터 API | `app/api/admin/stats/` | 집계 쿼리 |
| 1.8 | 날짜 범위 필터 | 대시보드 UI | 기간 선택 |
| 1.9 | 모임별 현황 요약 | 대시보드 UI | 모임별 참가자/수입 |

#### Scenario (검증 기준)

---

**🔴 SC-M5-001: 운영자 대시보드 접근 성공**

- **Given:** 운영자(admin) 계정으로 로그인한 상태
- **When:** /admin 페이지로 이동
- **Then:** 대시보드 페이지가 정상 표시됨
- **선행:** 없음

---

**🔴 SC-M5-002: 비운영자 대시보드 접근 차단**

- **Given:** 일반 회원 계정으로 로그인한 상태
- **When:** /admin 페이지로 이동 시도
- **Then:** 접근 거부 메시지 표시 및 홈으로 리다이렉트
- **선행:** 없음

---

**🔴 SC-M5-003: 이번 달 참가 현황 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 참가 현황 카드 확인
- **Then:** 이번 달 총 참가자 수가 정확히 표시됨
- **선행:** SC-M5-001

---

**🔴 SC-M5-004: 이번 달 수입 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 수입 카드 확인
- **Then:** 이번 달 총 결제 금액(콩)이 정확히 표시됨
- **선행:** SC-M5-001

---

**🔴 SC-M5-005: 이번 달 환불 내역 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 환불 내역 카드 확인
- **Then:** 이번 달 환불 건수와 금액이 표시됨
- **선행:** SC-M5-001

---

**🟡 SC-M5-006: 세그먼트별 회원 수 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 세그먼트 섹션 확인
- **Then:** 신규/활성/휴면/이탈 회원 수가 각각 표시됨
- **선행:** SC-M5-001

---

**🟡 SC-M5-007: 재참여율 통계 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 재참여율 섹션 확인
- **Then:** 최근 3개월 재참여율 수치가 표시됨
- **선행:** SC-M5-001

---

**🟡 SC-M5-008: 기간 필터 변경 성공**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 날짜 범위를 "지난 달"로 변경
- **Then:** 모든 통계가 지난 달 데이터로 업데이트됨
- **선행:** SC-M5-001

---

**🟢 SC-M5-009: 기간 필터 - 잘못된 범위**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 시작일이 종료일보다 늦은 범위 선택
- **Then:** "올바른 날짜 범위를 선택해주세요" 에러 메시지 표시
- **선행:** SC-M5-001

---

**🟡 SC-M5-010: 모임별 현황 표시**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 모임별 현황 섹션 확인
- **Then:** 각 모임의 참가자 수, 수입이 목록으로 표시됨
- **선행:** SC-M5-001

---

**🟢 SC-M5-011: 데이터 없는 기간 조회**

- **Given:** 운영자가 대시보드 페이지에 진입
- **When:** 모임이 없는 과거 기간 선택
- **Then:** "해당 기간에 데이터가 없습니다" 메시지 표시
- **선행:** SC-M5-001

---

#### 사용자 가치
> "운영자가 대시보드에서 서비스 현황을 한눈에 파악할 수 있다"

---

### Phase 2: 권한 관리 시스템

**목표:** 부운영자에게 제한된 권한을 부여할 수 있다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 2.1 | roles 정의 (admin, sub_admin, user) | DB 스키마 | 역할 enum |
| 2.2 | 권한별 접근 가능 기능 정의 | 문서/코드 | 권한 매트릭스 |
| 2.3 | 권한 부여 UI | 회원 관리 페이지 | 역할 변경 |
| 2.4 | 권한 부여 확인 모달 | UI | 재확인 절차 |
| 2.5 | 권한 변경 API | API | 역할 업데이트 |
| 2.6 | 권한 변경 로그 기록 | DB | audit_logs |
| 2.7 | RLS 정책 확장 | Supabase | 역할별 접근 제어 |
| 2.8 | 부운영자 접근 제한 | 미들웨어 | 특정 기능 차단 |

#### Scenario (검증 기준)

---

**🔴 SC-M5-012: 부운영자 권한 부여 성공**

- **Given:** 관리자(admin) 계정으로 회원 관리 페이지 진입
- **When:** 일반 회원 선택 후 "부운영자로 지정" 버튼 클릭 후 확인
- **Then:** 해당 회원의 role이 sub_admin으로 변경됨
- **선행:** 없음

---

**🔴 SC-M5-013: 부운영자 권한 부여 - 확인 모달 표시**

- **Given:** 관리자가 회원 관리 페이지에서 회원 선택
- **When:** "부운영자로 지정" 버튼 클릭
- **Then:** "정말 OOO님을 부운영자로 지정하시겠습니까?" 확인 모달 표시
- **선행:** 없음

---

**🟡 SC-M5-014: 부운영자 권한 부여 - 취소**

- **Given:** 부운영자 지정 확인 모달 표시 상태
- **When:** "취소" 버튼 클릭
- **Then:** 모달 닫힘, 회원 역할 변경 없음
- **선행:** SC-M5-013

---

**🔴 SC-M5-015: 부운영자 접근 범위 - 허용 기능**

- **Given:** 부운영자(sub_admin) 계정으로 로그인
- **When:** 입금 확인 페이지 접근
- **Then:** 정상적으로 페이지 표시 및 기능 사용 가능
- **선행:** SC-M5-012

---

**🔴 SC-M5-016: 부운영자 접근 범위 - 차단 기능**

- **Given:** 부운영자(sub_admin) 계정으로 로그인
- **When:** 권한 관리 페이지 접근 시도
- **Then:** 접근 거부 메시지 표시
- **선행:** SC-M5-012

---

**🟡 SC-M5-017: 부운영자 통계 페이지 접근 차단**

- **Given:** 부운영자(sub_admin) 계정으로 로그인
- **When:** 대시보드 통계 섹션 접근 시도
- **Then:** 통계 데이터 비표시 또는 접근 거부
- **선행:** SC-M5-012

---

**🟡 SC-M5-018: 권한 변경 로그 기록 확인**

- **Given:** 관리자가 부운영자 권한 부여 완료
- **When:** audit_logs 테이블 조회
- **Then:** 변경 일시, 변경자, 대상, 이전 역할(user), 이후 역할(sub_admin) 기록됨
- **선행:** SC-M5-012

---

**🟡 SC-M5-019: 부운영자 권한 해제**

- **Given:** 관리자가 회원 관리 페이지에서 부운영자 선택
- **When:** "일반 회원으로 변경" 버튼 클릭 후 확인
- **Then:** 해당 회원의 role이 user로 변경됨
- **선행:** SC-M5-012

---

**🟢 SC-M5-020: 부운영자가 다른 회원 권한 변경 시도**

- **Given:** 부운영자(sub_admin) 계정으로 로그인
- **When:** 다른 회원의 권한 변경 시도
- **Then:** 권한 변경 버튼 비표시 또는 API 거부
- **선행:** SC-M5-012

---

#### 사용자 가치
> "관리자가 부운영자에게 제한된 권한을 부여하여 업무를 분담할 수 있다"

---

### Phase 3: 알림 & 콘텐츠 관리

**목표:** 운영자가 알림 템플릿과 배너를 관리할 수 있다
**예상 소요:** 3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 3.1 | notification_templates 테이블 | DB 스키마 | 템플릿 저장 |
| 3.2 | 알림 템플릿 목록 페이지 | 운영자 페이지 | 템플릿 조회 |
| 3.3 | 알림 템플릿 수정 UI | 운영자 페이지 | 내용 편집 |
| 3.4 | 알림 On/Off 토글 | 템플릿 목록 | 개별 비활성화 |
| 3.5 | 템플릿 변수 안내 | 수정 UI | {{name}}, {{meeting}} 등 |
| 3.6 | banners 테이블 | DB 스키마 | 배너 저장 |
| 3.7 | 배너 관리 페이지 | 운영자 페이지 | CRUD |
| 3.8 | 배너 순서/노출 설정 | 배너 관리 | 우선순위, On/Off |
| 3.9 | 홈 화면 배너 표시 | 홈 UI | 활성 배너 슬라이드 |

#### Scenario (검증 기준)

---

**🔴 SC-M5-021: 알림 템플릿 목록 조회**

- **Given:** 운영자가 알림 템플릿 관리 페이지 진입
- **When:** 페이지 로드 완료
- **Then:** 모든 알림 템플릿(모임 리마인드, 월말 독려 등) 목록 표시
- **선행:** 없음

---

**🔴 SC-M5-022: 알림 템플릿 수정 성공**

- **Given:** 운영자가 알림 템플릿 목록에서 "모임 리마인드" 선택
- **When:** 내용을 수정하고 저장 버튼 클릭
- **Then:** "템플릿이 저장되었습니다" 메시지, 수정 내용 DB 반영
- **선행:** SC-M5-021

---

**🟡 SC-M5-023: 알림 템플릿 수정 - 필수 변수 누락**

- **Given:** 운영자가 알림 템플릿 수정 중
- **When:** 필수 변수({{name}})를 삭제하고 저장 시도
- **Then:** "필수 변수 {{name}}이 누락되었습니다" 경고 표시
- **선행:** SC-M5-021

---

**🔴 SC-M5-024: 알림 Off 설정**

- **Given:** 운영자가 알림 템플릿 목록 페이지
- **When:** "월말 참여 독려" 알림의 토글을 Off로 변경
- **Then:** 해당 알림 비활성화 상태 저장, 이후 발송 중단
- **선행:** SC-M5-021

---

**🟡 SC-M5-025: 알림 On 설정**

- **Given:** 비활성화된 알림 템플릿 존재
- **When:** 해당 알림의 토글을 On으로 변경
- **Then:** 해당 알림 활성화 상태 저장, 이후 정상 발송
- **선행:** SC-M5-024

---

**🔴 SC-M5-026: 배너 등록 성공**

- **Given:** 운영자가 배너 관리 페이지에서 "새 배너 등록" 클릭
- **When:** 이미지 업로드, 링크 URL 입력 후 저장
- **Then:** 배너 등록 완료, 목록에 새 배너 표시
- **선행:** 없음

---

**🟡 SC-M5-027: 배너 등록 - 이미지 없음**

- **Given:** 운영자가 새 배너 등록 폼 작성 중
- **When:** 이미지 없이 저장 시도
- **Then:** "배너 이미지를 업로드해주세요" 에러 메시지
- **선행:** 없음

---

**🟡 SC-M5-028: 배너 순서 변경**

- **Given:** 여러 배너가 등록된 상태
- **When:** 배너 순서를 드래그로 변경
- **Then:** 변경된 순서가 저장되고 홈 화면에 반영됨
- **선행:** SC-M5-026

---

**🟡 SC-M5-029: 배너 비활성화**

- **Given:** 활성화된 배너 존재
- **When:** 해당 배너의 노출 설정을 Off로 변경
- **Then:** 홈 화면에서 해당 배너 미표시
- **선행:** SC-M5-026

---

**🔴 SC-M5-030: 홈 화면 배너 표시**

- **Given:** 활성화된 배너가 2개 이상 존재
- **When:** 일반 회원이 홈 화면 접근
- **Then:** 배너 슬라이드가 설정된 순서대로 표시됨
- **선행:** SC-M5-026

---

**🟢 SC-M5-031: 활성 배너 없을 때 홈 화면**

- **Given:** 모든 배너가 비활성화된 상태
- **When:** 일반 회원이 홈 화면 접근
- **Then:** 배너 영역 미표시 또는 기본 이미지 표시
- **선행:** 없음

---

#### 사용자 가치
> "운영자가 알림 내용을 직접 수정하고 홈 화면 배너를 관리할 수 있다"

---

### Phase 4: 회원 & 예외 처리

**목표:** 문의 답변, 노쇼 처리, 입금 미매칭 수동 처리가 가능하다
**예상 소요:** 2~3일

#### 작업 목록

| # | 작업 | 산출물 | 완료 기준 |
|---|------|--------|----------|
| 4.1 | inquiries 테이블 | DB 스키마 | 문의 저장 |
| 4.2 | 요청함 (문의/건의) 목록 | 운영자 페이지 | 문의 조회 |
| 4.3 | 문의 상세 및 답변 UI | 운영자 페이지 | 답변 작성 |
| 4.4 | 답변 완료 상태 변경 | API | 상태 업데이트 |
| 4.5 | 노쇼 회원 처리 기능 | 운영자 페이지 | 노쇼 기록 |
| 4.6 | 노쇼 횟수 누적 | DB | 경고 단계 |
| 4.7 | 입금 미매칭 목록 | 운영자 페이지 | 미매칭 조회 |
| 4.8 | 수동 매칭 기능 | 운영자 페이지 | 입금자명 수정 |
| 4.9 | 수동 환불 처리 기능 | 운영자 페이지 | 계좌이체 환불 기록 |

#### Scenario (검증 기준)

---

**🔴 SC-M5-032: 문의 목록 조회**

- **Given:** 운영자가 요청함 페이지 진입
- **When:** 페이지 로드 완료
- **Then:** 미답변/답변완료 문의 목록이 표시됨
- **선행:** 없음

---

**🔴 SC-M5-033: 문의 답변 작성 성공**

- **Given:** 운영자가 미답변 문의 상세 페이지 진입
- **When:** 답변 내용 작성 후 저장
- **Then:** 답변 저장, 문의 상태가 "답변완료"로 변경
- **선행:** SC-M5-032

---

**🟡 SC-M5-034: 문의 답변 - 빈 내용**

- **Given:** 운영자가 문의 답변 작성 중
- **When:** 답변 내용 없이 저장 시도
- **Then:** "답변 내용을 입력해주세요" 에러 메시지
- **선행:** SC-M5-032

---

**🔴 SC-M5-035: 노쇼 처리 성공**

- **Given:** 운영자가 모임 상세 페이지에서 참가 확정 회원 목록 확인
- **When:** 노쇼 회원 선택 후 "노쇼 처리" 버튼 클릭
- **Then:** 노쇼 기록 저장, 해당 회원 노쇼 횟수 +1 증가
- **선행:** 없음

---

**🟡 SC-M5-036: 노쇼 처리 확인 모달**

- **Given:** 운영자가 노쇼 처리 버튼 클릭
- **When:** 모달 표시
- **Then:** "OOO님을 노쇼 처리하시겠습니까?" 확인 메시지 표시
- **선행:** 없음

---

**🔴 SC-M5-037: 노쇼 누적 경고 표시**

- **Given:** 노쇼 2회 이상인 회원 존재
- **When:** 운영자가 해당 회원 정보 조회
- **Then:** 노쇼 횟수와 경고 표시가 보임
- **선행:** SC-M5-035

---

**🟡 SC-M5-038: 노쇼 회원 제재 가능**

- **Given:** 노쇼 3회 이상인 회원 존재
- **When:** 운영자가 해당 회원 상세에서 "제재" 버튼 클릭
- **Then:** 해당 회원 신청 불가 상태로 변경 가능
- **선행:** SC-M5-037

---

**🔴 SC-M5-039: 입금 미매칭 목록 조회**

- **Given:** 입금자명 불일치로 미매칭 건이 존재
- **When:** 운영자가 입금 관리 페이지 진입
- **Then:** 미매칭 건 목록(입금자명, 금액, 날짜) 표시
- **선행:** 없음

---

**🔴 SC-M5-040: 입금 미매칭 수동 매칭 성공**

- **Given:** 운영자가 미매칭 건 상세 확인
- **When:** 올바른 회원 검색 후 "매칭" 버튼 클릭
- **Then:** 해당 신청이 confirmed 상태로 변경, 미매칭 목록에서 제거
- **선행:** SC-M5-039

---

**🟡 SC-M5-041: 입금 미매칭 - 잘못된 회원 매칭 시도**

- **Given:** 운영자가 미매칭 건에 회원 매칭 시도
- **When:** 해당 모임에 신청하지 않은 회원 선택
- **Then:** "해당 모임에 신청 내역이 없습니다" 에러 메시지
- **선행:** SC-M5-039

---

**🔴 SC-M5-042: 수동 환불 완료 처리**

- **Given:** 계좌이체 취소 건이 환불 대기 상태
- **When:** 운영자가 수동 환불 후 "환불 완료" 버튼 클릭
- **Then:** 환불 완료 상태로 변경, 완료 일시 기록
- **선행:** 없음

---

**🟡 SC-M5-043: 환불 대기 목록 조회**

- **Given:** 환불 대기 건이 존재
- **When:** 운영자가 환불 관리 페이지 진입
- **Then:** 환불 대기 목록(회원명, 금액, 환불 계좌 정보) 표시
- **선행:** 없음

---

**🟢 SC-M5-044: 환불 완료 - 이미 처리된 건**

- **Given:** 이미 환불 완료된 건
- **When:** 다시 "환불 완료" 처리 시도
- **Then:** "이미 환불 처리된 건입니다" 메시지
- **선행:** SC-M5-042

---

#### 사용자 가치
> "운영자가 문의에 답변하고 예외 상황을 처리하여 서비스를 원활하게 운영할 수 있다"

---

## 3. 기술 검토 사항

| 항목 | 내용 | 참고 |
|------|------|------|
| 통계 쿼리 | PostgreSQL 집계 함수, 인덱스 최적화 | 성능 고려 |
| RLS 확장 | role 기반 정책 | Supabase RLS |
| 권한 매트릭스 | admin: 전체 / sub_admin: 입금확인, 모임관리 | 문서화 |
| 배너 이미지 | Supabase Storage 또는 외부 CDN | 이미지 최적화 |
| 감사 로그 | audit_logs 테이블 | 보안 |

---

## 4. Scenario 요약

| Phase | 🔴 Critical | 🟡 High | 🟢 Medium | 합계 |
|-------|:-----------:|:-------:|:---------:|:----:|
| Phase 1: 운영 대시보드 | 5 | 4 | 2 | 11 |
| Phase 2: 권한 관리 | 5 | 4 | 1 | 10 |
| Phase 3: 알림 & 콘텐츠 | 4 | 5 | 2 | 11 |
| Phase 4: 회원 & 예외 | 6 | 5 | 2 | 13 |
| **총계** | **20** | **18** | **7** | **45** |

---

## 5. 전체 완료 검증

- [ ] Phase 1: 운영 대시보드 완료 (SC-M5-001 ~ SC-M5-011)
- [ ] Phase 2: 권한 관리 시스템 완료 (SC-M5-012 ~ SC-M5-020)
- [ ] Phase 3: 알림 & 콘텐츠 관리 완료 (SC-M5-021 ~ SC-M5-031)
- [ ] Phase 4: 회원 & 예외 처리 완료 (SC-M5-032 ~ SC-M5-044)
- [ ] 모든 Scenario 통과
- [ ] 부운영자 계정 테스트 완료
- [ ] main 머지 완료

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-29 | 1.0 | WP-M5 최초 작성 |
| 2026-01-29 | 2.0 | Scenario 전면 개편 - 1행동=1검증 원칙, Given/When/Then 형식, 성공/실패 케이스 쌍 추가 (18개 → 44개) |
