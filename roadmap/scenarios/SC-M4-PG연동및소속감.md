# Scenario: M4 - PG 결제 및 소속감

**Work Package:** WP-M4
**총 Scenario 수:** 47개
**작성일:** 2026-01-29

---

## Phase 1: PG 결제 연동

### 🔴 Critical Scenarios

**Scenario M4-001: 카카오페이 결제 성공**
- **Given:** 로그인 상태, 모임 상세 페이지에서 "신청하기" 클릭
- **When:** 카카오페이 선택 -> 결제 앱에서 결제 완료
- **Then:** 즉시 confirmed 상태, 마이페이지에서 "신청완료" 표시, payments 테이블에 기록
- **선행:** 없음

**Scenario M4-002: 토스페이먼츠 결제 성공**
- **Given:** 로그인 상태, 모임 상세 페이지에서 "신청하기" 클릭
- **When:** 토스 선택 -> 결제 앱에서 결제 완료
- **Then:** 즉시 confirmed 상태, 마이페이지에서 "신청완료" 표시, payments 테이블에 기록
- **선행:** 없음

**Scenario M4-003: 결제 웹훅 정상 처리**
- **Given:** 사용자가 결제 완료, 포트원에서 웹훅 발송
- **When:** /api/webhooks/portone 엔드포인트에서 웹훅 수신
- **Then:** HMAC 서명 검증 성공, application 상태를 confirmed로 업데이트
- **선행:** M4-001

### 🟡 High Scenarios

**Scenario M4-004: 웹훅 서명 검증 실패**
- **Given:** 잘못된 서명을 가진 웹훅 요청
- **When:** /api/webhooks/portone 엔드포인트에서 웹훅 수신
- **Then:** 401 Unauthorized 반환, 상태 변경 없음, 보안 로그 기록
- **선행:** M4-003

**Scenario M4-005: 결제 실패 - 잔액 부족**
- **Given:** 결제 진행 중
- **When:** 결제 실패 (잔액 부족)
- **Then:** "결제에 실패했습니다. 잔액을 확인해주세요" 메시지 표시, application 생성 안됨
- **선행:** M4-001

**Scenario M4-006: 결제 실패 - 사용자 취소**
- **Given:** 결제 앱으로 이동 후
- **When:** 사용자가 결제 취소
- **Then:** "결제가 취소되었습니다" 메시지 표시, 모임 상세 페이지로 복귀
- **선행:** M4-001

**Scenario M4-007: 결제 수단 선택 UI**
- **Given:** 신청 모달 오픈
- **When:** 결제 수단 선택 영역 표시
- **Then:** 카카오페이, 토스페이먼츠, 계좌이체 3가지 옵션 표시
- **선행:** 없음

### 🟢 Medium Scenarios

**Scenario M4-008: 정원 마감 시 결제 차단**
- **Given:** 모임 정원 14명 중 14명 confirmed
- **When:** 15번째 사용자가 "신청하기" 클릭
- **Then:** "정원이 마감되었습니다. 대기 신청하시겠습니까?" 안내 표시
- **선행:** M4-001

---

## Phase 2: 자동 환불 시스템

### 🔴 Critical Scenarios

**Scenario M4-009: 전액 환불 (D-5 이전)**
- **Given:** 모임 5일 전 이상, PG 결제 완료 상태
- **When:** 취소 요청
- **Then:** 100% 자동 환불 처리, refunds 테이블에 기록
- **선행:** M4-001

**Scenario M4-010: 부분 환불 (D-5 ~ D-2)**
- **Given:** 모임 5일~2일 전, PG 결제 완료 상태
- **When:** 취소 요청
- **Then:** 규정에 따른 부분 환불 (예: 50%), refunds 테이블에 기록
- **선행:** M4-001

**Scenario M4-011: 환불 불가 (D-2 이내)**
- **Given:** 모임 2일 이내, PG 결제 완료 상태
- **When:** 취소 요청
- **Then:** 환불 불가 안내 표시, 취소만 처리 (환불 0원)
- **선행:** M4-001

### 🟡 High Scenarios

**Scenario M4-012: 환불 금액 사전 안내**
- **Given:** 취소 모달 오픈
- **When:** 환불 규정 조회
- **Then:** 예상 환불 금액 표시 (예: "10,000원 중 5,000원 환불 예정")
- **선행:** M4-009

**Scenario M4-013: 계좌이체 취소 시 수동 환불 안내**
- **Given:** 계좌이체로 결제한 경우
- **When:** 취소 요청
- **Then:** 환불 계좌 입력 폼 표시, 수동 환불 처리 안내
- **선행:** M4-009

**Scenario M4-014: 환불 API 실패 처리**
- **Given:** PG 결제 취소 요청 중
- **When:** 포트원 환불 API 실패
- **Then:** "환불 처리 중 오류가 발생했습니다" 메시지, 운영자에게 알림, 수동 처리 대기
- **선행:** M4-009

**Scenario M4-015: 취소 사유 입력 필수**
- **Given:** 취소 모달 오픈, 취소 사유 미입력
- **When:** 취소 버튼 클릭
- **Then:** "취소 사유를 입력해주세요" 오류 표시, 취소 처리 안됨
- **선행:** M4-009

### 🟢 Medium Scenarios

**Scenario M4-016: 환불 내역 마이페이지 표시**
- **Given:** 환불 처리 완료된 건 존재
- **When:** 마이페이지 > 신청 내역 조회
- **Then:** 해당 건에 "환불완료 (5,000원)" 표시
- **선행:** M4-009

---

## Phase 3: 참여 완료 및 칭찬하기

### 🔴 Critical Scenarios

**Scenario M4-017: 참여 완료 알림 발송**
- **Given:** 모임 종료 후 3일 경과, confirmed 참가자 존재
- **When:** 참여 완료 Cron 실행
- **Then:** 참가자에게 "[모임명] 어떠셨어요?" 알림 발송
- **선행:** M4-001

**Scenario M4-018: 칭찬하기 성공**
- **Given:** 참여 완료 페이지에서 "칭찬하기" 선택
- **When:** 참가자 닉네임 목록에서 1명 선택 후 칭찬 문구 선택 -> 제출
- **Then:** 익명 칭찬 저장 (praises 테이블), 상대방 칭찬 수 +1
- **선행:** M4-017

**Scenario M4-019: 참여했어요 선택 시 참여 완료 처리**
- **Given:** 참여 완료 페이지 진입
- **When:** "참여했어요" 버튼 클릭
- **Then:** 참여 완료 처리 (completed 상태), 참여 횟수 +1
- **선행:** M4-017

### 🟡 High Scenarios

**Scenario M4-020: 모임당 1명 칭찬 제한**
- **Given:** 이미 해당 모임에서 칭찬함
- **When:** 다시 칭찬 시도
- **Then:** "이미 칭찬하셨습니다" 안내 표시, 칭찬 불가
- **선행:** M4-018

**Scenario M4-021: 3개월 동일인 칭찬 제한**
- **Given:** 3개월 내 동일인(회원 B) 칭찬 이력 존재
- **When:** 칭찬 대상 선택 시
- **Then:** 회원 B가 목록에서 선택 불가 상태로 표시 또는 안내
- **선행:** M4-018

**Scenario M4-022: 7일 미응답 자동 참여 완료**
- **Given:** 참여 완료 알림 후 7일 경과, 미응답
- **When:** 자동 완료 Cron 실행
- **Then:** 자동으로 "참여 완료" 처리, 참여 횟수 +1
- **선행:** M4-017

**Scenario M4-023: 칭찬 문구 선택형**
- **Given:** 칭찬하기 화면 진입
- **When:** 칭찬 문구 영역 표시
- **Then:** 5가지 선택형 문구 표시 (덕분에 좋은 시간이었어요, 이야기가 인상 깊었어요 등)
- **선행:** M4-018

**Scenario M4-024: 본인 칭찬 불가**
- **Given:** 칭찬 대상 선택 화면
- **When:** 참가자 목록 표시
- **Then:** 본인은 목록에서 제외됨
- **선행:** M4-018

### 🟢 Medium Scenarios

**Scenario M4-025: 누적 칭찬 수 표시**
- **Given:** 칭찬 받은 회원 (칭찬 수 5개)
- **When:** 마이페이지 조회
- **Then:** "받은 칭찬: 5개" 표시
- **선행:** M4-018

**Scenario M4-026: 칭찬 알림은 익명**
- **Given:** 회원 A가 회원 B를 칭찬
- **When:** 회원 B가 칭찬 알림/내역 확인
- **Then:** "누군가 칭찬했습니다" 표시, 칭찬 발신자 정보 미표시
- **선행:** M4-018

---

## Phase 4: 배지 및 후기 시스템

### 🔴 Critical Scenarios

**Scenario M4-027: 첫 참여 배지 자동 부여**
- **Given:** 첫 모임 참여 완료 (참여 횟수 1회)
- **When:** 참여 완료 처리
- **Then:** "첫 발자국" 배지 자동 부여, user_badges 테이블에 기록
- **선행:** M4-019

**Scenario M4-028: 후기 작성 성공**
- **Given:** 참여 완료 페이지에서 "후기 남기기" 선택
- **When:** 후기 텍스트 입력 -> 제출
- **Then:** 후기 저장 (reviews 테이블), 참여 완료 처리
- **선행:** M4-017

### 🟡 High Scenarios

**Scenario M4-029: 참여 횟수 배지 (10회)**
- **Given:** 10회 참여 완료
- **When:** 10번째 참여 완료 처리
- **Then:** "10회 참여" 배지 자동 부여
- **선행:** M4-027

**Scenario M4-030: 배지 목록 조회**
- **Given:** 배지 획득 이력 (첫 발자국, 10회 참여)
- **When:** 마이페이지 배지 섹션 조회
- **Then:** 획득한 배지 목록 및 획득일 표시
- **선행:** M4-027

**Scenario M4-031: 새 배지 획득 알림**
- **Given:** 새 배지 조건 충족
- **When:** 배지 자동 부여
- **Then:** "축하합니다! [배지명] 배지를 획득했습니다" 알림 발송
- **선행:** M4-027

**Scenario M4-032: 후기 공개 동의**
- **Given:** 후기 작성 중
- **When:** "후킹페이지에 공개" 체크박스 선택 후 제출
- **Then:** is_public=true로 저장, 후킹 랜딩페이지에서 표시 가능
- **선행:** M4-028

**Scenario M4-033: 후기 비공개 기본값**
- **Given:** 후기 작성 중
- **When:** 공개 동의 체크박스 미선택 후 제출
- **Then:** is_public=false로 저장, 후킹 랜딩페이지에서 미표시
- **선행:** M4-028

### 🟢 Medium Scenarios

**Scenario M4-034: 중복 배지 부여 방지**
- **Given:** "첫 발자국" 배지 이미 보유
- **When:** 두 번째 참여 완료
- **Then:** "첫 발자국" 배지 중복 부여 안됨
- **선행:** M4-027

**Scenario M4-035: 연속 참여 배지 (4주)**
- **Given:** 4주 연속 매주 1회 이상 참여 완료
- **When:** 4주차 참여 완료 처리
- **Then:** "4주 연속" 배지 자동 부여
- **선행:** M4-027

---

## Phase 5: 마이페이지 확장 및 내 책장

### 🔴 Critical Scenarios

**Scenario M4-036: 참여 통계 표시**
- **Given:** 참여 완료 5회, 첫 참여일 2025-06-01인 회원
- **When:** 마이페이지 조회
- **Then:** 총 참여 횟수(5회), 연속 참여, "함께한 지 XXX일째" 정확히 표시
- **선행:** M4-019

**Scenario M4-037: 내 책장 조회**
- **Given:** 참여 완료된 모임의 책 2권 존재
- **When:** 내 책장 페이지 진입
- **Then:** 참여한 모임의 책 목록 (제목, 저자) 표시
- **선행:** M4-019

### 🟡 High Scenarios

**Scenario M4-038: 참여 완료 시 책장 자동 추가**
- **Given:** 모임 A (책: "데미안") 참여 완료 처리
- **When:** 참여 완료 처리 완료
- **Then:** 내 책장에 "데미안" 자동 추가
- **선행:** M4-037

**Scenario M4-039: 한 문장 기록 저장**
- **Given:** 내 책장에서 책 "데미안" 선택
- **When:** 한 문장 입력 ("새는 알에서 나오려고 투쟁한다") 후 저장
- **Then:** 해당 책에 감상 문장 저장됨
- **선행:** M4-037

**Scenario M4-040: 수동 책 등록**
- **Given:** 내 책장 페이지
- **When:** "책 추가" -> 제목/저자 입력 -> 저장
- **Then:** 새 책이 책장에 추가됨
- **선행:** M4-037

**Scenario M4-041: 같은 책 중복 등록 방지**
- **Given:** 내 책장에 "데미안" 이미 존재
- **When:** "데미안" 다시 추가 시도
- **Then:** "이미 등록된 책입니다" 안내, 추가 안됨
- **선행:** M4-040

**Scenario M4-042: 연속 참여 횟수 계산**
- **Given:** 1월, 2월, 3월 연속 참여 완료
- **When:** 마이페이지 통계 조회
- **Then:** "연속 3개월 참여 중" 표시
- **선행:** M4-036

### 🟢 Medium Scenarios

**Scenario M4-043: 총 등록 책 수 표시**
- **Given:** 내 책장에 책 5권 등록
- **When:** 내 책장 페이지 진입
- **Then:** "총 5권" 표시
- **선행:** M4-037

**Scenario M4-044: 책장 빈 상태 표시**
- **Given:** 내 책장에 등록된 책 0권
- **When:** 내 책장 페이지 진입
- **Then:** "아직 등록된 책이 없어요" 안내 표시
- **선행:** M4-037

**Scenario M4-045: 정기모임 자격 상태 표시**
- **Given:** 마지막 정기모임 참여: 2025-12-01
- **When:** 마이페이지 조회 (현재: 2026-01-29)
- **Then:** "마지막 정기모임 참여: 2025년 12월 1일" 표시, 자격 유효 상태
- **선행:** M4-036

**Scenario M4-046: 자격 만료 임박 경고 표시**
- **Given:** 마지막 정기모임 참여가 5개월 전
- **When:** 마이페이지 조회
- **Then:** "정기모임 자격 만료 임박" 경고 배지 표시
- **선행:** M4-045

**Scenario M4-047: 한 문장 기록 수정**
- **Given:** "데미안"에 한 문장 기록 존재
- **When:** 기록 수정 -> 저장
- **Then:** 수정된 한 문장으로 업데이트
- **선행:** M4-039

---

## 요약

| 분류 | 개수 |
|------|:----:|
| 🔴 Critical | 12개 |
| 🟡 High | 23개 |
| 🟢 Medium | 12개 |
| **총계** | **47개** |

### Phase별 분포

| Phase | 설명 | 🔴 | 🟡 | 🟢 | 합계 |
|-------|------|:--:|:--:|:--:|:----:|
| Phase 1 | PG 결제 연동 | 3 | 4 | 1 | 8 |
| Phase 2 | 자동 환불 시스템 | 3 | 4 | 1 | 8 |
| Phase 3 | 참여 완료 및 칭찬하기 | 3 | 5 | 2 | 10 |
| Phase 4 | 배지 및 후기 시스템 | 2 | 5 | 2 | 9 |
| Phase 5 | 마이페이지 확장 및 내 책장 | 2 | 5 | 5 | 12 |

### 성공/실패 케이스 분포

| 유형 | 개수 |
|------|:----:|
| 성공 케이스 | 42개 |
| 실패 케이스 | 5개 |

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-29 | 1.0 | SC-M4 최초 작성 |
