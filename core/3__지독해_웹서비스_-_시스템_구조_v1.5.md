# 지독해 웹서비스 - 시스템 구조

---

## 1. 개요

이 문서는 지독해 웹서비스의 시스템 구조, 데이터 흐름, 데이터베이스 설계를 정의합니다.

**관련 문서:**
- 서비스 개요 v1.3
- PRD v1.4
- 기술 스택 및 개발 로드맵 v1.2

> ℹ️ **버전 안내:** 이 문서는 v1.5입니다. (2026-01-28 업데이트)

---

## 2. 이 구조를 선택한 이유

### 2.1 지독해 서비스 특성에 맞는 구조

| 서비스 특성 | 구조적 대응 | 선택 이유 |
|------------|------------|----------|
| 소규모 시작 (250명) → 확장 가능성 | BaaS(Supabase) + Serverless(Vercel) | 초기 비용 0원, 성장에 따라 자동 확장 |
| 결제/환불 자동화 핵심 | PG 통합 API(포트원) + 웹훅 기반 | 부분 환불 지원, 운영자 개입 0 가능 |
| 알림 서비스 교체 가능성 | 알림 서비스 레이어 분리 | 솔라피 → NHN 30분 내 전환 가능 |
| AI 에이전트 개발/유지보수 | 레퍼런스 풍부한 기술 스택 | Next.js + Supabase 조합이 가장 많은 예제 보유 |
| 앱 확장 가능성 | API 중심 구조 | 프론트엔드만 React Native로 교체, 백엔드 그대로 |

### 2.2 대안 대비 장점

| 대안 | 단점 | 현재 구조의 장점 |
|------|------|-----------------|
| Firebase | NoSQL → 복잡한 관계 쿼리 어려움, 환불 계산/통계에 불리 | PostgreSQL로 SQL 쿼리 자유롭게 |
| 자체 서버 (AWS EC2 등) | 초기 비용 높음, 운영 부담 | 인프라 관리 불필요 |
| 직접 PG 연동 | PG사마다 다른 API, 전환 어려움 | 포트원으로 통합, PG 교체 용이 |

---

## 3. 구조가 만들어내는 시너지

### 3.1 기술 스택 간 시너지

| 조합 | 시너지 효과 |
|------|------------|
| Next.js + Vercel | 자동 배포, 프리뷰 환경으로 빠른 테스트. SSR로 후킹 랜딩페이지 SEO 최적화 |
| Supabase (DB + Auth + Realtime) | 인증 + DB 통합으로 복잡도 제거. 참가 인원 실시간 반영 기본 제공 |
| PostgreSQL + 환불 규정 테이블 | 새 모임 유형 추가 시 코드 수정 없이 DB만 추가 |
| 포트원 웹훅 + 대기자 로직 | 취소 발생 시 자동으로 대기자 알림 트리거 |
| Cron + 알림 템플릿 테이블 | 알림 시점/문구를 운영자가 코드 수정 없이 변경 가능 |

### 3.2 운영 관점 시너지

| 조합 | 시너지 효과 |
|------|------------|
| Supabase Realtime + 참가 인원 표시 | 새로고침 없이 "O명 참여" 실시간 갱신 |
| Row Level Security | 권한 관리 로직이 DB 레벨에서 해결, 보안 강화 |
| Vercel + GitHub | 커밋만 하면 자동 배포, 롤백도 클릭 한 번 |

---

## 4. 전체 시스템 구조

### 4.1 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────┐
│                            클라이언트                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │   회원 웹    │  │  운영자 웹   │  │ 후킹 랜딩   │                  │
│  │  (모바일)    │  │  (대시보드)  │  │  페이지     │                  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                  │
│         └────────────────┼────────────────┘                         │
│                    Next.js 14 (Vercel 배포)                          │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         API 레이어                                   │
│                   Next.js API Routes                                │
│         ┌──────────┬──────────┬──────────┬──────────┐               │
│         │  인증    │  모임    │  결제    │  알림    │               │
│         │  API    │  API    │  API    │  API    │               │
│         └────┬─────┴────┬─────┴────┬─────┴────┬─────┘               │
└──────────────┼──────────┼──────────┼──────────┼─────────────────────┘
               │          │          │          │
   ┌───────────┴──────────┴──────────┴──────────┴───────────┐
   │                                                         │
   ▼                                                         ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   Supabase   │  │    포트원    │  │   솔라피    │  │   카카오     │
│              │  │              │  │              │  │              │
│ • PostgreSQL │  │  결제 처리   │  │  알림톡     │  │  로그인      │
│ • Auth       │  │  환불 처리   │  │  발송       │  │  OAuth       │
│ • Realtime   │  │  웹훅 전송   │  │              │  │              │
│ • Storage    │  │              │  │              │  │              │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
```

### 4.2 스케줄링 구조

자동 알림 발송을 위한 스케줄러 구조:

```
┌─────────────────────────────────────────────────────────────┐
│                    스케줄링 시스템                           │
│                                                             │
│  Vercel Cron 또는 Supabase pg_cron                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              스케줄 작업 목록                         │   │
│  │                                                      │   │
│  │  • 매일 09:00 - 모임 리마인드 대상자 조회 + 발송     │   │
│  │  • 매일 10:00 - 대기자 응답 시간 초과 체크            │   │
│  │  • 매일 11:00 - 세그먼트별 리마인드 발송              │   │
│  │  │             (온보딩 이탈 위험, 휴면 위험, 자격 만료 임박) │
│  │  • 매월 25일 - 월말 참여 독려 알림                    │   │
│  │  • 매일 00:00 - 참여 완료 자동 처리 (7일 경과)        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름

### 5.1 핵심 가치별 데이터 흐름 개요

| 핵심 가치 | 관련 데이터 흐름 | 핵심 테이블 |
|----------|-----------------|------------|
| **쉬운 연결** | 신청/결제, 취소/환불, 대기자 처리, 자격 체크 | registrations, waitlists, refund_policies |
| **잊지 않게** | 모임 리마인드, 월말 독려, 세그먼트별 리마인드 | notification_templates, notification_logs |
| **소속감** | 참여 완료→통계, 배지 획득, 칭찬 축적, 책장 등록 | registrations, badges, praises, bookshelf |
| **신뢰** | 결제 검증, 환불 자동화, 대시보드 집계 | registrations, payments |
| **신규 전환** | 신규→기존 회원 전환 | users |

### 5.2 신청/결제 흐름

```
회원: 신청 클릭
    │
    ▼
서버: 정기모임 자격 체크 (정기모임 외 모임인 경우)
    │
    ├── 자격 없음 → 정기모임 안내 팝업 → 종료
    └── 자격 있음 (또는 정기모임) → 계속
    │
    ▼
서버: 신청 레코드 생성 (status: pending)
    │
    ▼
회원: 포트원 결제 진행
    │
    ▼
포트원 → 서버: 웹훅으로 결제 완료 알림
    │
    ▼
서버: 결제 검증 + 신청 확정 (status: confirmed)
    │
    ▼
회원: 완료 화면 (Realtime으로 즉시 반영)
```

### 5.3 취소/환불 흐름

```
회원: 취소 요청 + 사유 입력
    │
    ▼
서버: 환불 규정 계산
    │
    ├── 정기모임: **5일 전** 100%, 2일 전 50%, 이후 불가
    └── 토론모임: 2주 전 100%, 7일 전 50%, 이후 불가
    │
    ▼
서버 → 포트원: 환불 API 호출 (부분 환불 포함)
    │
    ▼
서버: DB 업데이트 (status: cancelled, refund_amount)
    │
    ▼
서버: 대기자 있으면 → 1순위에게 알림 발송
```

### 5.4 대기자 처리 흐름

```
취소 발생 → 자리 생김
    │
    ▼
1순위 대기자에게 알림톡 발송
    │
    ▼
응답 대기 시간 설정
    ├── 모임 3일 전 이전: 24시간
    ├── 모임 3~1일 전: 6시간
    └── 모임 1일 전 이후: 2시간
    │
    ├── 응답 O → 결제 → 신청 확정
    └── 응답 X → 다음 대기자에게 알림
```

### 5.5 알림 발송 흐름 (세그먼트 기반)

```
스케줄러: 매일 실행
    │
    ▼
세그먼트별 대상 조회
    │
    ├── 모임 리마인드: 모임 3일/1일/당일 전 신청자
    ├── 월말 독려: 해당 월 신청 없는 회원
    ├── 온보딩 이탈 위험: 첫 참여 후 45일 경과, 두 번째 참여 없음
    ├── 휴면 위험: 마지막 참여 3개월 경과
    └── 자격 만료 임박: 마지막 정기모임 참여 5개월 경과
    │
    ▼
리마인드 우선순위 적용 (중복 발송 방지)
    │
    ※ 우선순위: 자격 만료 임박 > 휴면 위험 > 온보딩 이탈 위험 > 월말 독려
    │
    ▼
알림 템플릿 조회 (운영자가 수정 가능한 문구)
    │
    ▼
알림 서비스 모듈 호출 (추상화 레이어)
    │
    ├── 현재: 솔라피 API
    └── 추후: NHN Cloud 등으로 교체 가능
    │
    ▼
카카오 알림톡 발송
    │
    ▼
발송 결과 기록 (notification_logs)
```

### 5.6 참여 완료 판단 흐름

```
모임 종료 3일 후
    │
    ▼
알림톡: "○○ 모임 어떠셨어요?"
    │
    ├── [칭찬하기] 선택 → 참여 완료 처리
    ├── [참여했어요] 선택 → 참여 완료 처리
    ├── [후기 남기기] 선택 → 참여 완료 처리
    └── 7일 미응답 → 자동 참여 완료 처리
    
※ 노쇼는 운영자가 수동으로 "미참여" 처리
```

### 5.7 참여 완료 → 통계/배지 업데이트 흐름

```
참여 완료 처리
    │
    ▼
서버: 참여 기록 저장
    │
    ├── 누적 참여 횟수 +1
    ├── 연속 참여 계산 (이전 모임과 2주 이내면 연속)
    ├── 마지막 참여일 업데이트
    └── 정기모임인 경우: last_regular_meeting_at 업데이트
    │
    ▼
배지 조건 체크 트리거
    │
    ├── 첫 참여 배지: 참여 횟수 1회 달성
    ├── 10회 배지: 참여 횟수 10회 달성
    └── 연속 4주 배지: 연속 참여 4주 달성
    │
    ├── 조건 충족 + 미보유 → 배지 부여
    └── 조건 미충족 or 이미 보유 → 스킵
```

### 5.8 신규 → 기존 회원 전환 흐름

```
회원가입 완료
    │
    ▼
서버: users.is_new_member = true 설정
    │
    ▼
첫 정기모임 참여 완료
    │
    ▼
서버: users.is_new_member = false 전환
    │
    ▼
서버: users.first_regular_meeting_at 기록
    │
    ▼
후기 요청 알림 발송 (강한 유도)
```

### 5.9 칭찬 축적 흐름

```
칭찬하기 선택
    │
    ▼
서버: 칭찬 유효성 검증
    │
    ├── 같은 모임에서 이미 칭찬했는지? → 차단
    └── 같은 사람에게 3개월 내 칭찬했는지? → 차단
    │
    ▼
서버: 칭찬 저장 (praises 테이블)
    │
    ▼
수신자 누적 칭찬 수 업데이트 (users.total_praises_received)
    │
    ▼
배지 조건 체크 (칭찬 10개/30개/50개 배지)
```

### 5.10 책장 등록 흐름

```
책장 등록 요청 (두 가지 경로)
    │
    ├── 경로 A: 참여 완료 후 자동 유도 → "이번 모임에서 읽은 책을 기록하세요"
    └── 경로 B: 마이페이지 책장에서 직접 추가
    │
    ▼
서버: 중복 체크 (같은 책 이미 등록?)
    │
    ├── 중복 → 안내 후 종료
    └── 신규 → 계속
    │
    ▼
서버: 책 정보 저장 (제목, 저자)
    │
    ▼
한 문장 기록 입력 유도 (선택)
    │
    ▼
서버: 한 문장 기록 저장 (입력한 경우)
```

### 5.11 기타 데이터 흐름 (상세 다이어그램 생략)

| 흐름 | 설명 |
|------|------|
| 후기 작성/공개 | 후기 저장 → 공개 동의 시 is_public = true → 후킹페이지 쿼리에 포함 |
| 대시보드 집계 | 운영자 접근 시 SQL 집계 쿼리로 참가/수입/환불/재참여율 계산 |
| 정기모임 자격 체크 | 토론모임 등 신청 시 users.last_regular_meeting_at이 6개월 이내인지 확인 |

---

## 6. 데이터베이스 구조

### 6.1 핵심 테이블 관계

```
┌──────────────┐
│    users     │ ─────────┬─────────┬─────────┬─────────┐
└──────────────┘          │         │         │         │
                          ▼         ▼         ▼         ▼
                   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
                   │registra- │ │waitlists │ │ praises  │ │ badges   │
                   │tions     │ │          │ │          │ │          │
                   └────┬─────┘ └────┬─────┘ └──────────┘ └──────────┘
                        │            │
                        ▼            ▼
                   ┌────────────────────┐
                   │     meetings       │
                   └─────────┬──────────┘
                             │
                             ▼
                   ┌────────────────────┐
                   │  refund_policies   │
                   └────────────────────┘
```

### 6.2 테이블 목록

| 테이블 | 용도 |
|--------|------|
| users | 회원 정보 (실명, 닉네임), 역할, 정기모임 자격 상태, 신규 회원 여부 |
| meetings | 모임 정보, 유형, 환불 규정 연결 |
| refund_policies | 환불 규정 (모임 유형별) |
| registrations | 신청 정보, 결제 상태, 참여 완료 상태 |
| waitlists | 대기 정보, 순번, 응답 기한 |
| praises | 칭찬 기록 (익명, 선택 문구) |
| badges | 배지 획득 기록 |
| bookshelf | 내 책장 (책 제목, 저자, 한 문장 기록) |
| suggestions | 건의/피드백 |
| notification_templates | 알림 템플릿 (운영자 수정 가능) |
| notification_logs | 알림 발송 기록 (종류, 수신자, 발송 일시, 결과) |
| admin_permissions | 운영자 권한 |
| banners | 홈 화면 배너 |
| reviews | 모임 후기 (모든 회원 작성 가능, 공개 동의 여부) |

### 6.3 핵심 데이터 설계 원칙

| 원칙 | 적용 |
|------|------|
| 환불 규정 유연성 | refund_policies 테이블로 분리, 새 모임 유형 추가 시 코드 수정 불필요 |
| 칭찬 중복 방지 | 한 모임당 1명 (unique 제약), 3개월 내 동일인 중복 (쿼리로 체크) |
| 정기모임 자격 체크 | users.last_regular_meeting_at으로 6개월 이내 여부 확인 |
| 참여 완료 추적 | registrations에 participation_status, participation_method 기록 |
| 후기 공개 관리 | reviews.is_public으로 후킹페이지 노출 여부 관리 |
| 신규 회원 전환 | users.is_new_member가 첫 정기모임 참여 완료 시 false로 자동 전환 |
| 세그먼트 동적 계산 | 세그먼트는 별도 테이블 없이, 마지막 참여일/참여 횟수 기반으로 조회 시 계산 |
| 알림 효과 측정 | notification_logs와 registrations 조인으로 리마인드 후 행동 추적 |
| 실명/닉네임 분리 | users.name(실명)은 본인/운영자만 조회, nickname은 타 사용자에게 노출. 참가자 목록, 칭찬, 후기 등에서 닉네임 사용 |

### 6.4 회원 세그먼트 계산 로직

세그먼트는 테이블에 저장하지 않고, 조회 시점에 동적으로 계산한다.

| 세그먼트 | 계산 조건 |
|----------|----------|
| 신규 | is_new_member = true |
| 온보딩 중 | is_new_member = false AND 첫 정기모임 참여 후 30일 이내 |
| 온보딩 이탈 위험 | 첫 정기모임 참여 후 30~60일 AND 두 번째 참여 완료 없음 |
| 온보딩 이탈 | 첫 정기모임 참여 후 60일 이상 AND 두 번째 참여 완료 없음 |
| 성장 중 | 참여 완료 횟수 2~4회 AND 마지막 참여 완료 3개월 이내 |
| 충성 (활성) | 참여 완료 횟수 5회 이상 AND 마지막 참여 완료 3개월 이내 |
| 휴면 위험 | 마지막 참여 완료 3~5개월 전 (모든 모임 기준) |
| 자격 만료 임박 | 마지막 정기모임 참여 완료 5~6개월 전 |
| 자격 만료 | 마지막 정기모임 참여 완료 6개월 이상 전 |

**참고:**
- "참여"는 모두 "참여 완료" 기준. 신청만 하고 취소/노쇼는 참여로 카운트하지 않음.
- 세그먼트는 상호 배타적이지 않음. 예: "충성 + 휴면 위험" 동시 해당 가능.
- "자격 만료 임박"은 **정기모임** 기준, "휴면 위험"은 **모든 모임** 기준.

**리마인드 발송 시 우선순위 (중복 방지):**
```
자격 만료 임박 > 휴면 위험 > 온보딩 이탈 위험 > 월말 독려
```
※ 같은 날 여러 세그먼트에 해당하면 우선순위가 높은 알림만 발송

---

## 7. API 엔드포인트 구조

### 7.1 주요 API 그룹

| 그룹 | 주요 기능 |
|------|----------|
| 인증 (Auth) | 회원가입, 로그인, 카카오 로그인, 로그아웃 |
| 모임 (Meetings) | 목록 조회, 상세 조회, 참가자 목록, 생성/수정/삭제 |
| 신청 (Registrations) | 신청 준비, 확정, 취소, 내 신청 목록 |
| 대기 (Waitlists) | 대기 등록, 취소, 신청 전환 |
| 결제 (Payments) | 웹훅 수신, 환불 처리 |
| 알림 (Notifications) | 수동 발송, 템플릿 관리 |
| 참여 (Participations) | 칭찬, 건의, 후기, 참여 확인, 노쇼 처리 |
| 마이페이지 (Profile) | 내 정보, 참여 통계, 배지, 책장 |
| 관리자 (Admin) | 대시보드, 요청함, 권한 관리, 배너 관리 |
| 스케줄 (Cron) | 리마인드, 대기 만료, 월말 독려, 세그먼트 알림, 자동 완료 |

---

## 8. 보안 및 권한 구조

### 8.1 권한 레벨

| 역할 | 권한 범위 |
|------|----------|
| member (일반 회원) | 본인 데이터 조회/수정, 모임 조회, 신청/취소 |
| admin (운영자) | 부여받은 권한에 따라 기능 접근 |
| super_admin (메인 운영자) | 모든 권한 + 다른 운영자 권한 관리 |

### 8.2 운영자 권한 종류

| 권한 | 설명 |
|------|------|
| meeting_manage | 모임 생성/수정/삭제 |
| notification_send | 알림톡 수동 발송 |
| banner_manage | 홈 화면 배너 관리 |
| request_respond | 요청함 답변 |
| dashboard_view | 대시보드 열람 |
| template_manage | 알림 템플릿 관리 |

### 8.3 데이터 접근 제어

Row Level Security (RLS) 적용:
- 회원: 본인 데이터만 조회/수정
- 신청: 본인 것만 조회, 관리자는 전체 조회
- 모임: 모든 사용자 조회 가능, 관리자만 수정

---

## 9. 위험성 및 대응 방안

### 9.1 높은 위험

| 위험 | 영향 | 발생 가능성 | 대응 방안 |
|------|------|------------|----------|
| Supabase 서비스 장애 | 전체 서비스 중단 | 낮음 (99.9% SLA) | 중요 데이터 정기 백업, 장애 시 안내 페이지 |
| 포트원/PG사 장애 | 결제 불가 | 낮음 | "잠시 후 시도" 안내, 수동 계좌이체 백업 안내 |
| 결제 웹훅 유실 | 결제했는데 미반영 | 중간 | 웹훅 재시도 설정, 결제 상태 수동 조회 기능 |

### 9.2 중간 위험

| 위험 | 영향 | 발생 가능성 | 대응 방안 |
|------|------|------------|----------|
| Vercel 무료 티어 한계 초과 | 서비스 느려짐 | 중간 (성장 시) | 트래픽 모니터링, Pro 플랜 전환 준비 |
| Supabase 무료 티어 한계 초과 | DB 접근 제한 | 중간 (성장 시) | 스토리지/인증 수 모니터링, Pro 전환 |
| 알림톡 발송 실패 | 회원이 모임 잊음 | 중간 | 실패 로그 확인, 재발송 기능 |
| 동시 결제로 인한 정원 초과 | 14명 초과 결제 | 낮음 | DB 레벨 동시성 제어 |

### 9.3 낮은 위험

| 위험 | 설명 | 대응 |
|------|------|------|
| Vendor Lock-in | Supabase/Vercel에 종속 | PostgreSQL 표준이라 DB 이전 가능 |
| Serverless Cold Start | 첫 요청 시 약간의 지연 | 250명 규모에서는 체감 어려움 |
| 해외 서버 지연 | 한국 직접 리전 없음 | 싱가포르 리전 사용으로 최소화 |

---

## 10. 구현 불가능/어려운 기능

### 10.1 현재 구조로 불가능한 기능

| 기능 | 불가능 이유 | 필요한 구조 변경 |
|------|------------|-----------------|
| 실시간 화상/음성 통화 | Supabase Realtime은 데이터 동기화용 | WebRTC 서버 또는 Agora/Twilio 연동 |
| 대용량 파일 업로드 (100MB+) | Serverless 제한 | 별도 파일 서버 또는 S3 직접 업로드 |
| 복잡한 ML/AI 기능 | Serverless는 장시간 연산 불가 | 별도 ML 서버 또는 외부 AI API |
| 푸시 알림 (앱) | 웹 전용 구조 | 앱 전환 시 푸시 서버 추가 |

### 10.2 2차 기능 구현 가능 여부

| 2차 기능 | 현재 구조 대응 가능 |
|---------|-------------------|
| 결제 수단 미리 등록 | ✅ 가능 (포트원 빌링키) |
| 대기 선결제 → 자동환불 | ✅ 가능 (포트원 환불 API) |
| 캘린더 자동 추가 | ✅ 가능 (Google Calendar API) |
| 정기모임 개설 요청/투표 | ✅ 가능 (DB 테이블 추가) |
| 다른 회원 책장 구경 | ✅ 가능 (공개 설정 필드 추가) |
| 참여 리포트 생성 | ✅ 가능 (SQL 집계 쿼리) |
| 클럽장 정산 자동화 | ✅ 가능 (정산 테이블 + 로직) |
| 토론모임/지글챌 전용 기능 | ✅ 가능 (meeting_type 확장) |
| 앱 전환 (React Native) | ✅ 가능 (API 그대로, 프론트만 교체) |
| 진행자 시스템 | ✅ 가능 (users 참여 횟수 기반 자격 판정 + cron 선정 + 알림 발송) |
| 오늘의 지독해 (소식 피드) | ✅ 가능 (reviews, bookshelf, praises, meetings 테이블 조합 쿼리 + 익명 필드 추가) |

### 10.3 구조 변경이 필요한 미래 시나리오

| 시나리오 | 트리거 조건 | 필요한 구조 변경 |
|---------|------------|-----------------|
| 회원 10,000명 이상 | 동시 접속 500명+ | Supabase Enterprise 또는 자체 PostgreSQL |
| 실시간 채팅 도입 | 모임 내 채팅 요청 | 별도 채팅 서비스 (SendBird 등) |
| 복잡한 추천 시스템 | "맞춤 모임 추천" 요구 | ML 서버 또는 외부 추천 API |

---

## 11. 개발 전략 및 품질 관리

### 11.1 동시성 처리 전략

정원 초과 방지 등 동시성이 필요한 시나리오에서 사용하는 전략:

| 시나리오 | 해결 전략 | 구현 위치 |
|---------|----------|----------|
| 동시 결제 시 정원 초과 | DB 레벨 `FOR UPDATE` 락 | `check_and_reserve_capacity()` 함수 |
| 대기자 순서 경쟁 | `waitlists.position` 컬럼 + 트랜잭션 | 대기 등록 API |
| 중복 웹훅 처리 | `payment_logs.idempotency_key` 체크 | 결제 웹훅 API |

```sql
-- 동시성 안전한 정원 체크 (schema.sql에 정의됨)
SELECT current_participants, capacity 
FROM meetings WHERE id = $1 
FOR UPDATE;  -- 다른 트랜잭션 차단
```

### 11.2 에러 처리 전략

| 에러 카테고리 | 코드 범위 | 예시 |
|-------------|----------|------|
| 인증 오류 | 1xxx | `AUTH_SESSION_EXPIRED`, `AUTH_UNAUTHORIZED` |
| 결제 오류 | 2xxx | `PAYMENT_FAILED`, `REFUND_NOT_ELIGIBLE` |
| 외부 서비스 | 3xxx | `NOTIFICATION_SEND_FAILED` |
| 비즈니스 로직 | 4xxx | `CAPACITY_EXCEEDED`, `ELIGIBILITY_NOT_MET` |
| 시스템 오류 | 5xxx | `INTERNAL_ERROR`, `DATABASE_ERROR` |

**사용자 메시지 원칙:**
- 기술적 세부사항 숨김
- 다음 행동 안내 (예: "다시 로그인해주세요")
- 친근하고 이해하기 쉬운 표현

### 11.3 API 설계 원칙

**URL 구조:**
```
/api/v1/
├── auth/           # 인증
├── meetings/       # 모임
├── registrations/  # 신청
├── payments/       # 결제
├── notifications/  # 알림
└── admin/          # 관리자
```

**표준 응답 형식:**
```typescript
// 성공
{ success: true, data: T, meta?: { pagination, timestamp } }

// 실패
{ success: false, error: { code: number, message: string, details? } }
```

### 11.4 보안 체크리스트

| 위협 | 방어 수단 | 검증 방법 |
|-----|----------|----------|
| 인증 우회 | Supabase RLS + 미들웨어 검증 | 권한 없는 API 호출 테스트 |
| 결제 위변조 | 포트원 웹훅 시그니처 검증 (HMAC-SHA256) | 잘못된 시그니처 거부 확인 |
| SQL 인젝션 | Supabase SDK (파라미터화) | 자동 방어 |
| 민감 정보 노출 | `SUPABASE_SERVICE_ROLE_KEY` 서버 전용 | 환경 변수 분리 |

### 11.5 테스트 전략

| 계층 | 도구 | 대상 | 시점 |
|------|------|------|------|
| Unit | Vitest | 환불 계산, 세그먼트 판정 | 코드 변경 시 |
| Integration | Playwright | API 엔드포인트 | API 변경 시 |
| E2E | Playwright | 핵심 사용자 플로우 | 배포 전 필수 |

**핵심 E2E 시나리오:**
1. 신규 회원: 가입 → 모임 조회 → 결제 → 마이페이지 확인
2. 기존 회원: 로그인 → 결제 → 취소 → 환불 확인
3. 운영자: 로그인 → 모임 생성 → 참가 현황 확인
4. 대기자: 대기 등록 → 자리 발생 → 알림 → 결제

---

## 12. 목표 달성 검증

### 12.1 PRD 목표 vs 구조적 해결

| PRD 목표 | 구조적 해결 | 검증 |
|----------|------------|------|
| 환불 운영자 개입 0건 | 포트원 환불 API + refund_policies 테이블 | ✅ |
| 리마인드 자동화 | Cron + notification_templates | ✅ |
| 실시간 참가 인원 | Supabase Realtime | ✅ |
| 운영자 권한 관리 | admin_permissions + RLS | ✅ |
| 알림 템플릿 수정 | notification_templates 테이블 | ✅ |
| 칭찬 중복 방지 | praises 테이블 UNIQUE + 3개월 쿼리 | ✅ |
| 신청 단계 축소 | 간편결제 연동 | ✅ |
| 신규 회원 재참여율 측정 | notification_logs + registrations 조인 | ✅ |
| 세그먼트별 리마인드 | 동적 세그먼트 계산 + Cron | ✅ |
| 온보딩/휴면 지표 측정 | users 필드 + 참여 기록 집계 | ✅ |

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2025-01-07 | 1.0 | 시스템 구조 문서 최초 작성 |
| 2025-01-07 | 1.1 | 후기 테이블 변경 (member_reviews → reviews, 모든 회원 작성 가능, 공개 동의 필드 추가), bookshelf 테이블에 한 문장 기록 필드 추가, 참여 완료 흐름 업데이트 |
| 2025-01-09 | 1.2 | 데이터 흐름 재구성 (핵심 가치 중심 10개 흐름), notification_logs 테이블 추가, 회원 세그먼트 계산 로직 추가, 리마인드 우선순위 추가, 설계 원칙 3개 추가 (신규 전환, 세그먼트 계산, 알림 효과 측정) |
| 2025-01-09 | 1.3 | 2차 기능 구현 가능 여부에 진행자 시스템, 오늘의 지독해 추가, 관련 문서 버전 업데이트 |
| 2026-01-14 | 1.4 | 섹션 11 추가 (동시성 처리, 에러 처리, API 설계, 보안, 테스트 전략). 시니어 개발자 피드백 반영 |
| 2026-01-28 | 1.5 | 환불 규정 수정 (정기모임 3일→5일), 버전 안내 업데이트, 관련 문서 버전 업데이트 (PRD v1.7) |
| 2026-01-29 | 1.6 | 닉네임 기반 서비스 전환: users 테이블에 nickname 필드 추가, 실명/닉네임 분리 설계 원칙 추가 |


